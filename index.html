<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>E-Trax!</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{background:#0b0b0b;color:white;font-family:Poppins,sans-serif;margin:0;min-height:100vh;}
header{display:none;background:#0b0b0b;border-bottom:1px solid #222;padding:15px 20px;border-radius:0 0 15px 15px;}
header .project-name{color:#00bcd4;font-weight:700;}
#loginContainer{text-align:center;margin-top:100px;}
#loginContainer button{font-size:1.2rem;padding:10px 30px;border:none;border-radius:10px;background:#00bcd4;color:#000;font-weight:600;cursor:pointer;}
.table-container{margin-top:20px;padding:20px;background:#1a1a1a;border-radius:15px;box-shadow:0 8px 25px rgba(0,0,0,.4);}
footer{background:#111;color:#aaa;text-align:center;padding:15px 20px;margin-top:40px;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginContainer">
  <button id="googleLoginBtn">Login with Google</button>
</div>

<!-- HEADER -->
<header>
  <div class="container-fluid d-flex justify-content-between align-items-center flex-wrap">
    <div><h1 class="project-name mb-1">E-TRAX</h1><div id="typingHeader" class="text-warning"></div></div>
    <div id="userNameDisplay"></div>
    <nav class="d-flex align-items-center">
      <a href="#" id="aboutLink" class="me-3 text-white">About</a>
      <button id="googleLogoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
    </nav>
  </div>
</header>

<!-- ONLINE USERS -->
<div class="container my-3 text-center">
  <div style="background:#1a1a1a;border-radius:15px;padding:15px;">
    <h5 class="text-info">üë• Active Users Online: <span id="onlineCount">0</span></h5>
    <ul id="onlineUsers" style="list-style:none;padding:0;margin-top:10px;"></ul>
  </div>
</div>

<!-- EXPENSE FORM -->
<div class="container my-3" id="expenseFormContainer" style="display:none;">
  <div class="card bg-dark text-white mb-4" style="border-radius:20px;">
    <div class="card-body">
      <form id="expenseForm" class="row g-3">
        <input type="hidden" id="editId">
        <div class="col-md-6"><label>Name</label><input type="text" id="name" class="form-control" required></div>
        <div class="col-md-6"><label>Amount</label><input type="number" id="amount" class="form-control" required></div>
        <div class="col-md-6">
          <label>Type</label>
          <select id="type" class="form-select" required>
            <option value="">Choose...</option>
            <option value="Card">Card</option><option value="Cash">Cash</option>
            <option value="Gpay/Paytm">Gpay/Paytm</option><option value="Other">Other</option>
          </select>
        </div>
        <div class="col-md-6"><label>Description</label><input type="text" id="description" class="form-control" required></div>
        <div class="col-md-6"><label>Date</label><input type="date" id="date" class="form-control" required></div>
        <div class="col-12 d-flex justify-content-between mt-3">
          <button type="reset" class="btn btn-danger">Clear</button>
          <button type="submit" class="btn btn-primary">Confirm</button>
        </div>
      </form>
    </div>
  </div>
  <div id="tableContainer" class="table-responsive"></div>
  <div id="analyticsContainer" class="my-4" style="display:none;">
    <div class="table-container">
      <h4 class="text-center text-info mb-3">üìä Expense Analytics</h4>
      <div class="row"><div class="col-md-6"><canvas id="lineChart"></canvas></div><div class="col-md-6"><canvas id="pieChart"></canvas></div></div>
    </div>
  </div>
</div>

<div id="msgBox" style="position:fixed;top:20px;right:20px;background:#198754;color:white;padding:10px 20px;border-radius:10px;display:none;z-index:9999;"></div>

<footer>
  <p>Developed by <b style="color:#00bcd4;">Prime Sandy</b> | &copy;2025 E-Trax</p>
</footer>

<script>
const BASE_URL = window.location.hostname.includes("localhost") ? "http://localhost:3000" : "https://sandy-backend2-0.onrender.com";

// üî• Firebase Config
const firebaseConfig = {
  apiKey:"AIzaSyDgeOmsWD36spVcXw9QVSbUs4nmx-iXGak",
  authDomain:"ptspro-31997.firebaseapp.com",
  databaseURL:"https://ptspro-31997-default-rtdb.firebaseio.com",
  projectId:"ptspro-31997",
  storageBucket:"ptspro-31997.appspot.com",
  messagingSenderId:"191965542623",
  appId:"1:191965542623:web:b461ceedfc3a773267516a"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
let currentUserUid=null;

const loginBtn=document.getElementById("googleLoginBtn"),logoutBtn=document.getElementById("googleLogoutBtn"),
loginContainer=document.getElementById("loginContainer"),expenseFormContainer=document.getElementById("expenseFormContainer"),
tableContainer=document.getElementById("tableContainer"),msgBox=document.getElementById("msgBox"),
userNameDisplay=document.getElementById("userNameDisplay"),analyticsContainer=document.getElementById("analyticsContainer");

function showMessage(msg,dur=2000){msgBox.innerText=msg;msgBox.style.display="block";setTimeout(()=>msgBox.style.display="none",dur);}
function toggleLoginState(x){loginContainer.style.display=x?"none":"block";logoutBtn.style.display=x?"inline-block":"none";expenseFormContainer.style.display=x?"block":"none";document.querySelector("header").style.display=x?"block":"none";}

// üë• PRESENCE FUNCTIONS
function setUserOnline(uid,name){
  const ref=db.ref("presence/"+uid);
  ref.set({online:true,name,lastSeen:Date.now()});
  ref.onDisconnect().set({online:false,name,lastSeen:Date.now()});
  setInterval(()=>ref.update({online:true,lastSeen:Date.now()}),30000);
}
function showOnlineUsers(){
  const ref=db.ref("presence");
  ref.on("value",snap=>{
    const data=snap.val()||{};const now=Date.now();
    const online=Object.values(data).filter(u=>u.online&&(now-u.lastSeen)<60000);
    document.getElementById("onlineCount").innerText=online.length;
    const ul=document.getElementById("onlineUsers");ul.innerHTML="";
    online.forEach(u=>{
      const s=Math.floor((now-u.lastSeen)/1000);
      ul.innerHTML+=`<li><span style="color:lime;">‚óè</span> ${u.name} ‚Äì <small>${s}s ago</small></li>`;
    });
  });
}

// Firebase Auth listener
auth.onAuthStateChanged(user=>{
  if(user){
    currentUserUid=user.uid;
    toggleLoginState(true);
    userNameDisplay.textContent=user.displayName||"User";
    loadData();
    setUserOnline(user.uid,user.displayName||"User");
    showOnlineUsers();
  }else{
    currentUserUid=null;
    toggleLoginState(false);
    tableContainer.innerHTML="<p class='text-muted'>Login to view your expenses</p>";
    analyticsContainer.style.display="none";
    userNameDisplay.textContent="";
  }
});

// Login/Logout
loginBtn.onclick=async()=>{
  const provider=new firebase.auth.GoogleAuthProvider();
  try{const r=await auth.signInWithPopup(provider);currentUserUid=r.user.uid;showMessage("‚úÖ Logged in");}
  catch(e){showMessage("‚ùå Login failed");}
};
logoutBtn.onclick=async()=>{await auth.signOut();showMessage("‚úÖ Logged out");};

// Typing animation
const text="Drop Your Expenses !";let i=0;
(function type(){if(i<text.length){document.getElementById("typingHeader").innerHTML+=text.charAt(i);i++;setTimeout(type,100);}
else{setTimeout(()=>{document.getElementById("typingHeader").innerHTML="";i=0;type();},2000);}})();

// Expense form
document.getElementById("expenseForm").addEventListener("submit",async e=>{
  e.preventDefault();if(!currentUserUid)return;
  const data={uid:currentUserUid,name:name.value,amount:amount.value,type:type.value,description:description.value,date:date.value};
  const url=editId.value?`${BASE_URL}/update/${editId.value}`:`${BASE_URL}/submit`;
  const method=editId.value?"PUT":"POST";
  const res=await fetch(url,{method,headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
  const result=await res.json();showMessage(result.message);editId.value="";e.target.reset();loadData();
});

// Load expenses
async function loadData(){
  if(!currentUserUid)return;
  const r=await fetch(`${BASE_URL}/users?uid=${currentUserUid}`);const arr=await r.json();
  if(!arr.length){tableContainer.innerHTML="<p>No expenses yet.</p>";analyticsContainer.style.display="none";return;}
  let total=0;let html=`<table class="table table-striped table-bordered text-white"><thead><tr><th>#</th><th>Name</th><th>Amt</th><th>Type</th><th>Desc</th><th>Date</th><th>Action</th></tr></thead><tbody>`;
  arr.forEach((u,i)=>{total+=+u.amount;html+=`<tr><td>${i+1}</td><td>${u.name}</td><td>${u.amount}</td><td>${u.type}</td><td>${u.description}</td><td>${u.date}</td><td><button class='btn btn-warning btn-sm' onclick="editExpense('${u._id}')">Edit</button></td></tr>`;});
  html+=`<tr style='background:#00bcd4;color:#000;font-weight:700;'><td colspan='2' class='text-end'>Total</td><td colspan='5'>${total.toFixed(2)}</td></tr></tbody></table>`;
  tableContainer.innerHTML=html;analyticsContainer.style.display="block";renderCharts(arr);
}
window.editExpense=async id=>{
  const r=await fetch(`${BASE_URL}/user/${id}`);const u=await r.json();
  name.value=u.name;amount.value=u.amount;type.value=u.type;description.value=u.description;date.value=u.date;editId.value=id;showMessage("‚úè Edit mode");
};
function renderCharts(data){
  const dates={},types={};data.forEach(u=>{dates[u.date]=(dates[u.date]||0)+(+u.amount||0);types[u.type]=(types[u.type]||0)+(+u.amount||0);});
  new Chart(lineChart,{type:'line',data:{labels:Object.keys(dates),datasets:[{label:'Total',data:Object.values(dates),borderColor:'#00bcd4',backgroundColor:'rgba(0,188,212,0.2)',fill:true,tension:.3}]},options:{scales:{y:{beginAtZero:true}}}});
  new Chart(pieChart,{type:'pie',data:{labels:Object.keys(types),datasets:[{data:Object.values(types),backgroundColor:['#00bcd4','#ff9800','#8bc34a','#e91e63','#9c27b0']}]}})
}
</script>
</body>
</html>
