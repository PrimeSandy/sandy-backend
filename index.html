<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>E-Trax!</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { background-color:#0b0b0b; color:white; min-height:100vh; margin:0; font-family:"Poppins",sans-serif; }
header { display:none; background:#0b0b0b; border-bottom:1px solid #222; padding:15px 20px; border-radius:0 0 15px 15px; }
header .project-name { font-size:1.5rem; color:#00bcd4; font-weight:700; margin-bottom:3px; }
header .typing { font-size:1rem; color:#ffcc00; height:1.2rem; }
#userNameDisplay { flex:1; text-align:center; color:#ffcc00; font-weight:600; }
.table-container { margin-top:20px; padding:20px; background:#1a1a1a; border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.4); }
.table-container h4 { margin:0 0 12px 0; }
table { color:#fff; font-size:0.95rem; }
table thead { background:#00bcd4; color:#000; font-weight:600; }
.table-responsive { overflow:auto; }
#loginContainer { text-align:center; margin-top:100px; }
#budgetCard { display:none; margin-top:20px; border-radius:12px; padding:16px; background:#1a1a1a; box-shadow:0 8px 25px rgba(0,0,0,0.4); }
#aboutModal, #historyModal { display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.8); padding:50px 20px; box-sizing:border-box; overflow:auto; }
#historyModal .history-card { max-width:900px; margin:auto; background:#121212; padding:20px; border-radius:12px; border:1px solid #222; color:#fff; }
.history-entry { border-bottom:1px dashed #333; padding:10px 0; }
.field-changed { font-weight:700; color:#ffc107; }
.activity-item { padding:8px 0; border-bottom:1px dashed #222; }
footer { background:#111; color:#aaa; text-align:center; padding:15px 20px; border-top:1px solid #222; margin-top:40px; font-size:0.9rem; }
.blinking-name { color: #00bcd4; }
.btn-primary { background:#00bcd4; border-color:#00bcd4; color:#000; }
</style>
</head>
<body>

<!-- LOGIN BUTTON -->
<div id="loginContainer">
  <button id="googleLoginBtn" class="btn btn-lg">Login with Google</button>
</div>

<!-- HEADER -->
<header>
  <div class="container-fluid d-flex justify-content-between align-items-center flex-wrap">
    <div>
      <h1 class="project-name mb-1">E-TRAX</h1>
      <div class="typing" id="typingHeader"></div>
    </div>
    <div id="userNameDisplay"></div>
    <nav class="d-flex align-items-center nav-links">
      <a href="#" id="aboutLink">About</a>
      <button id="googleLogoutBtn" class="btn btn-sm">Logout</button>
    </nav>
  </div>
</header>

<!-- MAIN CONTAINER -->
<div class="container my-3">

  <!-- BUDGET CARD -->
  <div id="budgetCard">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <h5 style="margin:0;color:#ffc107;">Budget Limit</h5>
        <small class="text-muted">Set a monthly/total budget for your expenses</small>
      </div>
      <div>
        <button id="resetBudgetBtn" class="btn btn-sm btn-outline-danger">Reset Budget</button>
      </div>
    </div>

    <div class="row g-2 mb-2">
      <div class="col-md-4">
        <input type="number" id="budgetInput" class="form-control" placeholder="Enter budget amount (e.g. 5000)">
      </div>
      <div class="col-md-2">
        <button id="saveBudgetBtn" class="btn btn-primary">Save Budget</button>
      </div>
      <div class="col-md-6 text-end">
        <div id="budgetStatusText" style="font-weight:600;color:#fff;">No budget set</div>
      </div>
    </div>

    <div id="budgetBar" class="mb-2">
      <div id="budgetProgress" class="progress" style="width:100%">
        <div id="budgetProgressBar" class="progress-bar" role="progressbar" style="width:0%"></div>
      </div>
    </div>

    <div id="budgetAlerts" style="min-height:22px;"></div>
  </div>

  <!-- EXPENSE FORM -->
  <div id="expenseFormContainer" style="display:none;">
    <div class="card bg-dark text-white mb-4" style="border-radius:20px;">
      <div class="card-body">
        <form id="expenseForm" class="row g-3">
          <input type="hidden" id="editId">
          <div class="col-md-6">
            <label for="name" class="form-label">Name</label>
            <input type="text" id="name" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label for="amount" class="form-label">Amount</label>
            <input type="number" id="amount" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label for="type" class="form-label">Type</label>
            <select id="type" class="form-select" required>
              <option value="">Choose one...</option>
              <option value="Card">Card</option>
              <option value="Cash">Cash</option>
              <option value="Gpay/Paytm">Gpay/Paytm</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="description" class="form-label">Description</label>
            <input type="text" id="description" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label for="date" class="form-label">Date</label>
            <input type="date" id="date" class="form-control" required>
          </div>
          <div class="col-12 d-flex justify-content-between mt-3">
            <button type="reset" class="btn btn-danger">Clear</button>
            <button type="submit" class="btn btn-primary">Confirm</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- TABLE + CHART -->
  <div id="tableContainer" class="table-responsive"></div>

  <!-- Activity Log -->
  <div id="activityLog" style="display:none;">
    <h5 style="margin-top:0;color:#ffc107;">Recent Activity</h5>
    <div id="activityItems"></div>
  </div>

  <!-- GRAPHICAL ANALYTICS -->
  <div id="analyticsContainer" class="my-4" style="display:none;">
    <div class="table-container">
      <h4 class="text-center text-info mb-3">📊 Expense Analytics</h4>
      <div class="row">
        <div class="col-md-6">
          <canvas id="lineChart"></canvas>
        </div>
        <div class="col-md-6">
          <canvas id="pieChart"></canvas>
          <div id="analyticsBadge" class="text-center"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ABOUT MODAL -->
<div id="aboutModal">
  <div class="modal-content" style="max-width:700px;margin:auto;background:#1a1a1a;padding:30px;border-radius:20px;">
    <h2 style="color:#ffc107;text-align:center;">About Parallel Tracking Sense</h2>
    <p><strong>Parallel Tracking Sense</strong> helps you <strong>track your daily expenses</strong> and manage your budget efficiently.</p>
    <h4 style="color:#ffc107;">💡 Purpose</h4>
    <p>Record, categorize, and analyze your spending patterns easily.</p>
    <div style="text-align:center;"><button id="closeAbout" class="btn btn-primary">Close</button></div>
  </div>
</div>

<!-- History Modal -->
<div id="historyModal">
  <div class="history-card" id="historyContent">
    <!-- content injected dynamically -->
    <div style="text-align:right; margin-top:12px;">
      <button id="closeHistoryBtn" class="btn btn-sm btn-secondary">Close</button>
    </div>
  </div>
</div>

<div id="msgBox" style="position: fixed; top: 20px; right: 20px; background-color: #198754; color: white; padding: 10px 20px; border-radius: 10px; display: none; z-index: 9999;"></div>

<script>
/* --------------------------
  Config & globals
---------------------------*/
// BASE URL for backend: if using same host, use relative root
const BASE_URL = window.location.hostname.includes("localhost") ? "http://localhost:3000" : window.location.origin;

let socketIoLoaded = false;
let socket = null;

// Firebase init (keeps your existing config)
const firebaseConfig = {
  apiKey: "AIzaSyDgeOmsWD36spVcXw9QVSbUs4nmx-iXGak",
  authDomain: "ptspro-31997.firebaseapp.com",
  projectId: "ptspro-31997",
  storageBucket: "ptspro-31997.appspot.com",
  messagingSenderId: "191965542623",
  appId: "1:191965542623:web:b461ceedfc3a773267516a",
  measurementId: "G-6LNC29KRQF"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

let currentUserUid = null;
let currentBudgetAmount = 0;

/* DOM refs */
const loginBtn = document.getElementById("googleLoginBtn");
const logoutBtn = document.getElementById("googleLogoutBtn");
const loginContainer = document.getElementById("loginContainer");
const expenseFormContainer = document.getElementById("expenseFormContainer");
const tableContainer = document.getElementById("tableContainer");
const msgBox = document.getElementById("msgBox");
const userNameDisplay = document.getElementById("userNameDisplay");
const analyticsContainer = document.getElementById("analyticsContainer");
const budgetCard = document.getElementById("budgetCard");
const budgetInput = document.getElementById("budgetInput");
const saveBudgetBtn = document.getElementById("saveBudgetBtn");
const resetBudgetBtn = document.getElementById("resetBudgetBtn");
const budgetProgressBar = document.getElementById("budgetProgressBar");
const budgetStatusText = document.getElementById("budgetStatusText");
const budgetAlerts = document.getElementById("budgetAlerts");
const analyticsBadge = document.getElementById("analyticsBadge");
const aboutLink = document.getElementById("aboutLink");
const aboutModal = document.getElementById("aboutModal");
const closeAbout = document.getElementById("closeAbout");
const historyModal = document.getElementById("historyModal");
const historyContent = document.getElementById("historyContent");
const closeHistoryBtn = document.getElementById("closeHistoryBtn");
const form = document.getElementById("expenseForm");
const editId = document.getElementById("editId");

/* Helpers */
function showMessage(msg, duration=2000){
  msgBox.innerText = msg;
  msgBox.style.display = "block";
  setTimeout(()=> msgBox.style.display = "none", duration);
}
function formatDateString(d){
  if(!d) return "—";
  const dt = (typeof d === 'string' || typeof d === 'number') ? new Date(d) : d;
  if(isNaN(dt.getTime())) return String(d);
  const opts = { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' };
  return dt.toLocaleString('en-GB', opts);
}

/* Socket loader */
(function loadSocketIo(){
  const s = document.createElement('script');
  s.src = `${BASE_URL.replace(/\/$/,'')}/socket.io/socket.io.js`;
  s.onload = ()=> { socketIoLoaded = true; if(currentUserUid) connectSocket(); };
  s.onerror = ()=> { socketIoLoaded = false; };
  document.head.appendChild(s);
})();
function connectSocket(retries = 0){
  try {
    if(typeof io === 'undefined'){
      if(retries < 5) setTimeout(()=> connectSocket(retries+1), 800);
      else console.warn("socket.io client not available");
      return;
    }
    if(socket && socket.connected) return;
    socket = io(BASE_URL);
    socket.on("connect", ()=> {
      if(currentUserUid) socket.emit("join", currentUserUid);
    });
    socket.on("expenses-changed", ()=> loadData());
    socket.on("budget-changed", ()=> fetchBudget());
  } catch(err){ console.error("Socket error", err); }
}

/* Auth & UI */
function toggleLoginState(isLoggedIn){
  loginContainer.style.display = isLoggedIn ? "none" : "block";
  logoutBtn.style.display = isLoggedIn ? "inline-block" : "none";
  expenseFormContainer.style.display = isLoggedIn ? "block" : "none";
  document.querySelector("header").style.display = isLoggedIn ? "block" : "none";
  budgetCard.style.display = isLoggedIn ? "block" : "none";
  analyticsContainer.style.display = isLoggedIn ? analyticsContainer.style.display : "none";
  document.getElementById("activityLog").style.display = isLoggedIn ? "block" : "none";
}
auth.onAuthStateChanged(async user=>{
  if(user){
    currentUserUid = user.uid;
    toggleLoginState(true);
    userNameDisplay.textContent = user.displayName || "User";
    if(socketIoLoaded) connectSocket();
    else connectSocket();
    await loadData();
    await fetchBudget();
  } else {
    currentUserUid = null;
    toggleLoginState(false);
    tableContainer.innerHTML = "<p class='text-muted'>Login to view your expenses</p>";
    analyticsContainer.style.display = "none";
    userNameDisplay.textContent = "";
    clearBudgetUI();
    if(socket){ socket.disconnect(); socket = null; }
  }
});

/* Login / Logout */
loginBtn.addEventListener("click", async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    const result = await auth.signInWithPopup(provider);
    currentUserUid = result.user.uid;
    toggleLoginState(true);
    loadData();
    userNameDisplay.textContent = result.user.displayName || "User";
    showMessage("✅ Logged in successfully", 2000);
    fetchBudget();
  } catch(err){ console.error(err); showMessage("❌ Login failed",2000); }
});
logoutBtn && logoutBtn.addEventListener("click", async () => {
  try {
    await auth.signOut();
    currentUserUid = null;
    toggleLoginState(false);
    tableContainer.innerHTML = "<p class='text-muted'>Login to view your expenses</p>";
    analyticsContainer.style.display = "none";
    userNameDisplay.textContent = "";
    clearBudgetUI();
    if(socket){ socket.disconnect(); socket = null; }
    showMessage("✅ Logged out successfully",2000);
  } catch(err){ console.error(err); showMessage("❌ Logout failed",2000); }
});

/* Expense submit (create/update) */
form.addEventListener("submit", async e=>{
  e.preventDefault();
  if(!currentUserUid) return showMessage("Login first");
  const payload = {
    uid: currentUserUid,
    name: document.getElementById("name").value.trim(),
    amount: document.getElementById("amount").value.trim(),
    type: document.getElementById("type").value,
    description: document.getElementById("description").value.trim(),
    date: document.getElementById("date").value
  };

  try {
    const url = editId.value ? `${BASE_URL}/update/${editId.value}` : `${BASE_URL}/submit`;
    if(editId.value){
      payload.editorName = (auth.currentUser && auth.currentUser.displayName) ? auth.currentUser.displayName : null;
    }
    const res = await fetch(url, { method: editId.value ? "PUT" : "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    const result = await res.json();
    if(!res.ok) throw new Error(result.message || "Server error");
    showMessage(result.message || "Saved");
    editId.value = "";
    form.reset();
    await loadData();
    await fetchBudget();
  } catch(err){ console.error(err); showMessage("❌ Failed to submit/edit expense",2500); }
});

/* Budget functions (unchanged) */
async function saveBudgetToServer(amount){ if(!currentUserUid) return; try { const res = await fetch(`${BASE_URL}/setBudget`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ uid: currentUserUid, amount: parseFloat(amount) || 0 }) }); const r = await res.json(); if(res.ok) showMessage(r.message || "Budget saved"); else showMessage(r.message || "Failed to save budget"); await fetchBudget(); } catch(err){ console.error(err); showMessage("❌ Failed to save budget",2000); } }
async function fetchBudget(){ if(!currentUserUid) return clearBudgetUI(); try { const res = await fetch(`${BASE_URL}/getBudget?uid=${currentUserUid}`); if(!res.ok) return clearBudgetUI(); const r = await res.json(); if(!r || typeof r.amount === "undefined" || r.amount === 0){ currentBudgetAmount = 0; clearBudgetUI(); return; } currentBudgetAmount = parseFloat(r.amount) || 0; const expensesRes = await fetch(`${BASE_URL}/users?uid=${currentUserUid}`); const arr = await expensesRes.json(); let totalAmount = 0; if(Array.isArray(arr)) arr.forEach(x=> totalAmount += parseFloat(x.amount)||0); updateBudgetUI(currentBudgetAmount, totalAmount); budgetInput.value = currentBudgetAmount; } catch(err){ console.error(err); clearBudgetUI(); } }
function clearBudgetUI(){ budgetInput.value = ""; if(budgetProgressBar) budgetProgressBar.style.width = "0%"; if(budgetProgressBar) budgetProgressBar.className = "progress-bar"; budgetStatusText.innerText = "No budget set"; budgetAlerts.innerHTML = ""; currentBudgetAmount = 0; analyticsBadge.innerText = ""; }
function updateBudgetUI(budgetAmount, totalSpent){ if(!budgetAmount || budgetAmount <= 0){ clearBudgetUI(); return; } const pct = (totalSpent / budgetAmount) * 100; const pctClamped = Math.min(Math.round(pct), 999); const widthPct = Math.min(pctClamped, 100); budgetProgressBar.style.width = widthPct + "%"; budgetProgressBar.innerText = `${pctClamped}%`; budgetProgressBar.className = "progress-bar"; if(pct >= 100){ budgetProgressBar.classList.add("bg-danger"); } else if(pct >= 80){ budgetProgressBar.classList.add("bg-warning"); } else { budgetProgressBar.classList.add("bg-success"); } budgetStatusText.innerText = `Budget: ₹${budgetAmount.toFixed(2)}  —  Spent: ₹${totalSpent.toFixed(2)}`; budgetAlerts.innerHTML = ""; analyticsBadge.innerText = ""; if(pct >= 100){ const over = (totalSpent - budgetAmount); budgetAlerts.innerHTML = `<div class="text-danger" style="font-weight:700;">🚨 Budget exceeded! You spent ₹${over.toFixed(2)} over the limit.</div>`; analyticsBadge.innerHTML = `🚨 Over budget: ₹${over.toFixed(2)} (shown as red slice in chart)`; } else if(pct >= 80){ budgetAlerts.innerHTML = `<div class="text-warning" style="font-weight:700;">⚠️ You're at ${Math.round(pct)}% of your budget. Be careful!</div>`; analyticsBadge.innerHTML = `⚠️ Usage: ${Math.round(pct)}% of budget`; } else { analyticsBadge.innerHTML = `✅ Usage: ${Math.round(pct)}% of budget`; } }
saveBudgetBtn.addEventListener("click", async () => { const val = parseFloat(budgetInput.value); if(!val || val <= 0){ showMessage("Enter valid budget amount"); return; } await saveBudgetToServer(val); });
resetBudgetBtn.addEventListener("click", async () => { if(!currentUserUid) return; if(!confirm("Reset/delete your budget?")) return; try { const res = await fetch(`${BASE_URL}/setBudget`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ uid: currentUserUid, amount: 0, reset: true }) }); const r = await res.json(); if(res.ok) showMessage(r.message || "Budget reset"); else showMessage(r.message || "Reset failed"); clearBudgetUI(); } catch(err){ console.error(err); showMessage("❌ Reset failed",2000); } });

/* Activity log helpers (unchanged) */
function buildActivityLog(allUsers){ const log = []; allUsers.forEach(u => { if(u.createdAt) log.push({ type:'created', uid:u.uid, display:`${u.name} created`, date:u.createdAt, expenseId:u._id, by:u.uid }); if(Array.isArray(u.editHistory)){ u.editHistory.forEach(e=>{ log.push({ type:'edited', expenseName:u.name, expenseId:u._id, editorName:e.editorName || e.editorUid || 'Unknown', date:e.date, before:e.before, after:e.after, editorUid:e.editorUid }); }); } }); log.sort((a,b)=> new Date(b.date) - new Date(a.date)); return log; }
function renderActivityLog(allUsers){ const itemsDiv = document.getElementById('activityItems'); const container = document.getElementById('activityLog'); const log = buildActivityLog(allUsers); itemsDiv.innerHTML = ""; if(!log || log.length===0){ container.style.display = 'none'; return; } container.style.display = 'block'; const limited = log.slice(0,20); limited.forEach(it=>{ const div = document.createElement('div'); div.className = "activity-item"; if(it.type === 'created'){ div.innerHTML = `<div><strong>${it.display}</strong> — ${formatDateString(it.date)}</div>`; } else { const changed = []; if(it.before && it.after){ for(const k of Object.keys(it.before)) if(String(it.before[k]) !== String(it.after[k])) changed.push(k); } const fieldsText = changed.length ? `<span class="field-changed">${changed.join(', ')}</span>` : `<span class="text-muted">no fields</span>`; div.innerHTML = `<div><strong>${it.editorName}</strong> edited <strong>${it.expenseName || ''}</strong> — ${fieldsText} — ${formatDateString(it.date)}</div>`; } itemsDiv.appendChild(div); }); }

/* Load data (main) */
async function loadData(){
  if(!currentUserUid) return;
  try{
    const res = await fetch(`${BASE_URL}/users?uid=${currentUserUid}`);
    if(!res.ok){
      const text = await res.text().catch(()=>"");
      throw new Error(`Failed to fetch users: ${res.status} ${text}`);
    }
    const users = await res.json();
    if(!Array.isArray(users) || users.length === 0){
      tableContainer.innerHTML = "<p class='text-muted'>No expenses yet.</p>";
      analyticsContainer.style.display = "none";
      document.getElementById('activityLog').style.display = 'none';
      const bRes = await fetch(`${BASE_URL}/getBudget?uid=${currentUserUid}`);
      if(bRes.ok){
        const b = await bRes.json();
        if(b && b.amount) updateBudgetUI(parseFloat(b.amount), 0);
      }
      return;
    }

    let html = `<table class="table table-striped table-bordered text-white"><thead><tr>
      <th>#</th><th>Name</th><th>Amount</th><th>Type</th><th>Description</th><th>Date</th><th>Edits</th><th>Last Edited</th><th>Action</th>
    </tr></thead><tbody>`;

    let totalAmount = 0;
    users.forEach((u,i)=>{
      totalAmount += parseFloat(u.amount) || 0;
      const editCount = u.editCount || 0;
      const lastEdited = u.updatedAt || u.createdAt || null;
      const actionBtn = `<button class="btn btn-warning btn-sm" onclick="editExpense('${u._id}')">Edit</button>`;
      const historyBtn = `<button class="btn btn-info btn-sm ms-1" onclick="viewHistory('${u._id}')">History</button>`;
      html += `<tr>
        <td>${i+1}</td>
        <td>${u.name || ''}</td>
        <td>${u.amount}</td>
        <td>${u.type}</td>
        <td>${u.description}</td>
        <td>${u.date}</td>
        <td style="font-weight:700;">${editCount}</td>
        <td>${formatDateString(lastEdited)}</td>
        <td>${actionBtn}${historyBtn}</td>
      </tr>`;
    });

    html += `<tr style="background:#00bcd4; color:#000; font-weight:700;"><td colspan="2" class="text-end">Total</td><td colspan="7">${totalAmount.toFixed(2)}</td></tr>`;
    html += "</tbody></table>";
    tableContainer.innerHTML = html;

    analyticsContainer.style.display = "block";
    renderCharts(users);

    const bRes = await fetch(`${BASE_URL}/getBudget?uid=${currentUserUid}`);
    if(bRes.ok){
      const b = await bRes.json();
      if(b && b.amount && parseFloat(b.amount) > 0) updateBudgetUI(parseFloat(b.amount), totalAmount);
      else clearBudgetUI();
    }

    renderActivityLog(users);
  } catch(err){
    console.error(err);
    tableContainer.innerHTML = `<p class='text-danger'>Failed to load expenses. ${err.message ? ("(" + err.message + ")") : ""}</p>`;
  }
}

/* Edit handler */
window.editExpense = async function(id){
  try{
    const res = await fetch(`${BASE_URL}/user/${id}`);
    if(!res.ok) throw new Error("Failed to fetch user");
    const user = await res.json();
    document.getElementById("name").value = user.name || "";
    document.getElementById("amount").value = user.amount || "";
    document.getElementById("type").value = user.type || "";
    document.getElementById("description").value = user.description || "";
    document.getElementById("date").value = user.date || "";
    editId.value = id;
    showMessage("✏ Edit mode enabled",2000);
    window.scrollTo({ top: 0, behavior: "smooth" });
  } catch(err){ console.error(err); showMessage("❌ Failed to fetch expense for editing.",2500); }
};

/* --------------------------
   FIXED History view function
   This is the important fix — it now renders Created + each edit (before/after, editor, time)
---------------------------*/
window.viewHistory = async function(id){
  try{
    const res = await fetch(`${BASE_URL}/user/${id}`);
    if(!res.ok) throw new Error("Failed to fetch history");
    const u = await res.json();

    // Build HTML
    let html = `<h4 style="color:#ffc107;">History for: ${u.name || 'Expense'}</h4>`;
    html += `<div style="margin-top:8px;"><strong>Created:</strong> ${formatDateString(u.createdAt)}</div>`;
    html += `<div class="text-muted" style="margin-bottom:12px;">Initial values.</div>`;

    const hist = Array.isArray(u.editHistory) ? u.editHistory.slice().reverse() : [];
    if(hist.length === 0){
      html += `<div class="history-entry"><div class="text-muted">No edits yet.</div></div>`;
    } else {
      hist.forEach((h, idx) => {
        // for display we prefer friendly values
        const editor = h.editorName || h.editorUid || "Unknown";
        const editedAt = formatDateString(h.date || h.editedAt || h.timestamp || null);

        // safe getter for before/after fields (some entries might miss fields)
        const before = h.before || {};
        const after = h.after || {};

        html += `<div class="history-entry">
          <div><strong>#${hist.length - idx}</strong> Edited on <strong>${editedAt}</strong> by <strong>${editor}</strong></div>
          <div style="margin-top:6px;">
            <div><strong>Before:</strong> ${before.name ?? '—'}  |  ₹${(before.amount ?? '—')}  |  ${before.type ?? '—'}  ${before.description ? "| " + before.description : ""} ${before.date ? " | " + before.date : ""}</div>
            <div style="margin-top:6px;"><strong>After:</strong> ${after.name ?? '—'}  |  ₹${(after.amount ?? '—')}  |  ${after.type ?? '—'}  ${after.description ? "| " + after.description : ""} ${after.date ? " | " + after.date : ""}</div>
          </div>
        </div>`;
      });
    }

    // Inject content into modal container
    // keep close button
    html += `<div style="text-align:right; margin-top:12px;"><button id="closeHistoryBtnInner" class="btn btn-sm btn-secondary">Close</button></div>`;

    historyContent.innerHTML = html;

    // wire up close button inside injected content
    const closeInner = document.getElementById("closeHistoryBtnInner");
    closeInner && closeInner.addEventListener("click", ()=> { historyModal.style.display = "none"; });

    historyModal.style.display = "block";
  } catch(err){
    console.error(err);
    showMessage("❌ Failed to load history",2000);
  }
};

/* Charts (unchanged but complete) */
function renderCharts(users){
  const dates = {};
  const types = {};
  let totalAmount = 0;

  users.forEach(u=>{
    const date = u.date || "Unknown";
    const amount = parseFloat(u.amount) || 0;
    totalAmount += amount;
    dates[date] = (dates[date] || 0) + amount;
    const typeKey = (u.type && u.type.length) ? u.type : 'Other';
    types[typeKey] = (types[typeKey] || 0) + amount;
  });

  const overAmount = currentBudgetAmount && totalAmount > currentBudgetAmount ? (totalAmount - currentBudgetAmount) : 0;
  if(overAmount > 0){
    types[`Over Budget (₹${overAmount.toFixed(2)})`] = overAmount;
  }

  // Line Chart
  const lineCtx = document.getElementById('lineChart')?.getContext('2d');
  if(lineCtx){
    if(window.lineChartInstance) window.lineChartInstance.destroy();
    window.lineChartInstance = new Chart(lineCtx, {
      type: 'line',
      data: {
        labels: Object.keys(dates),
        datasets: [{
          label: 'Total Expense',
          data: Object.values(dates),
          borderColor: '#00bcd4',
          backgroundColor: 'rgba(0,188,212,0.2)',
          fill: true,
          tension: 0.3
        }]
      },
      options: { scales: { y: { beginAtZero:true } } }
    });
  }

  // Pie Chart
  const pieCtx = document.getElementById('pieChart')?.getContext('2d');
  if(pieCtx){
    if(window.pieChartInstance) window.pieChartInstance.destroy();
    const labels = Object.keys(types);
    const values = Object.values(types);
    const baseColors = ['#00bcd4','#ff9800','#8bc34a','#e91e63','#9c27b0','#3f51b5','#009688'];
    const bgColors = labels.map(l => l.startsWith("Over Budget") ? '#ff3b30' : baseColors.shift() || '#607d8b');

    window.pieChartInstance = new Chart(pieCtx, {
      type: 'pie',
      data: { labels, datasets: [{ data: values, backgroundColor: bgColors }] },
      options: {}
    });
  }

  if(overAmount > 0) analyticsBadge.innerText = `🚨 Over budget: ₹${overAmount.toFixed(2)} — shown as red slice in chart.`;
  else if(currentBudgetAmount > 0) analyticsBadge.innerText = `✅ Within budget: Budget ₹${currentBudgetAmount.toFixed(2)}, Spent ₹${totalAmount.toFixed(2)}.`;
  else analyticsBadge.innerText = "";
}

/* UI modals */
aboutLink.addEventListener('click', e=>{ e.preventDefault(); aboutModal.style.display = 'block'; });
closeAbout.addEventListener('click', ()=> aboutModal.style.display = 'none');
window.addEventListener('click', e=> { if(e.target === aboutModal) aboutModal.style.display='none'; if(e.target === historyModal) historyModal.style.display='none'; });
closeHistoryBtn.addEventListener('click', ()=> historyModal.style.display='none');

/* initial fallback UI */
tableContainer.innerHTML = "<p class='text-muted'>Login to view your expenses</p>";
</script>

<footer>
  <div style="display:flex; flex-direction:column; align-items:center; gap:5px;">
    <p style="margin:0;">Developed by <strong class="blinking-name">Prime Sandy</strong></p>
    <p style="margin:0;">Email: <a href="mailto:santhoshgowtham777@gmail.com" style="color:#00bcd4; text-decoration:none;">santhoshgowtham777@gmail.com</a></p>
    <p style="margin:0;">&copy; 2025 E-Trax. All rights reserved.</p>
  </div>
</footer>
</body>
</html>
