<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E-Trax!</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .navbar-brand { font-weight: bold; }
    .card { border-radius: 1rem; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
    .progress { height: 20px; }
    .table td, .table th { vertical-align: middle; }
    #historyList ul { padding-left: 20px; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">E-Trax</a>
      <div class="d-flex">
        <span id="userEmail" class="text-white me-2"></span>
        <button id="loginBtn" class="btn btn-light btn-sm">Login</button>
        <button id="logoutBtn" class="btn btn-outline-light btn-sm d-none">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container mt-4">
    <div class="row">
      <!-- Expense Form -->
      <div class="col-lg-4 mb-3">
        <div class="card">
          <div class="card-header bg-primary text-white">Add / Edit Expense</div>
          <div class="card-body">
            <form id="expenseForm">
              <input type="hidden" id="editingId">
              <div class="mb-2">
                <label class="form-label">Title</label>
                <input id="title" type="text" class="form-control" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Amount</label>
                <input id="amount" type="number" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Type</label>
                <select id="type" class="form-select" required>
                  <option value="">Select</option>
                  <option>Food</option>
                  <option>Travel</option>
                  <option>Shopping</option>
                  <option>Other</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary w-100" id="saveBtn">Add Expense</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Expense Table -->
      <div class="col-lg-8">
        <div class="card mb-3">
          <div class="card-header bg-success text-white">All Expenses</div>
          <div class="card-body table-responsive">
            <table class="table table-bordered table-striped mb-0">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Amount</th>
                  <th>Type</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="expenseTableBody">
                <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Budget / Analytics -->
        <div class="card">
          <div class="card-header bg-info text-white">Analytics</div>
          <div class="card-body">
            <p><strong>Total Spent:</strong> ₹<span id="totalAmount">0</span></p>
            <div class="progress mb-2">
              <div id="budgetProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%;"></div>
            </div>
            <p class="text-muted mb-0 small">Visual budget usage progress.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="historyModalLabel">History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="historyList">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // === Firebase Config ===
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    let currentUser = null;

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userEmailSpan = document.getElementById('userEmail');
    const expenseForm = document.getElementById('expenseForm');
    const expenseTableBody = document.getElementById('expenseTableBody');
    const totalAmountEl = document.getElementById('totalAmount');
    const budgetProgress = document.getElementById('budgetProgress');

    // Login & Logout
    loginBtn.addEventListener('click', async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
    });
    logoutBtn.addEventListener('click', () => auth.signOut());

    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        userEmailSpan.textContent = user.displayName || user.email;
        loginBtn.classList.add('d-none');
        logoutBtn.classList.remove('d-none');
      } else {
        userEmailSpan.textContent = '';
        loginBtn.classList.remove('d-none');
        logoutBtn.classList.add('d-none');
      }
    });

    // === Load Expenses ===
    async function loadExpenses() {
      const res = await fetch('/expenses');
      const data = await res.json();
      renderExpenses(data);
    }

    function renderExpenses(expenses) {
      expenseTableBody.innerHTML = '';
      if (!expenses.length) {
        expenseTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No expenses yet</td></tr>';
        totalAmountEl.textContent = '0';
        budgetProgress.style.width = '0%';
        return;
      }

      let total = 0;
      expenses.forEach(e => {
        total += e.amount;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.title}</td>
          <td>₹${e.amount}</td>
          <td>${e.type}</td>
          <td>${new Date(e.createdAt).toLocaleString()}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" onclick="editExpense('${e._id}')">Edit</button>
            <button class="btn btn-sm btn-info" onclick="showHistory('${e._id}','${e.title}')">History</button>
          </td>
        `;
        expenseTableBody.appendChild(tr);
      });
      totalAmountEl.textContent = total;
      const pct = Math.min(100, (total / 1000) * 100);
      budgetProgress.style.width = pct + '%';
    }

    // === Add or Edit Expense ===
    expenseForm.addEventListener('submit', async e => {
      e.preventDefault();
      const data = {
        title: title.value,
        amount: parseFloat(amount.value),
        type: type.value,
        user: currentUser ? currentUser.email : 'Guest'
      };
      const id = document.getElementById('editingId').value;
      if (id) await fetch(`/expenses/${id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
      else await fetch('/expenses', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
      expenseForm.reset();
      document.getElementById('editingId').value = '';
      document.getElementById('saveBtn').textContent = 'Add Expense';
      loadExpenses();
    });

    async function editExpense(id) {
      const res = await fetch(`/expenses/${id}`);
      const e = await res.json();
      document.getElementById('title').value = e.title;
      document.getElementById('amount').value = e.amount;
      document.getElementById('type').value = e.type;
      document.getElementById('editingId').value = e._id;
      document.getElementById('saveBtn').textContent = 'Update Expense';
    }

    // === FIXED HISTORY DISPLAY ===
    async function showHistory(id, title) {
      const modalTitle = document.getElementById('historyModalLabel');
      const historyList = document.getElementById('historyList');
      modalTitle.textContent = `History for: ${title}`;
      historyList.innerHTML = '<p class="text-muted">Loading...</p>';

      try {
        const res = await fetch(`/history/${id}`);
        const data = await res.json();
        if (!data) {
          historyList.innerHTML = '<p class="text-danger">No history found.</p>';
          return;
        }
        let html = `
          <p><strong>Created:</strong> ${data.createdAt ? new Date(data.createdAt).toLocaleString() : '—'}</p>
          <p><strong>Initial values:</strong></p>
          <ul>
            <li><b>Title:</b> ${data.title || '-'}</li>
            <li><b>Amount:</b> ₹${data.amount || '-'}</li>
            <li><b>Type:</b> ${data.type || '-'}</li>
          </ul>
        `;
        if (data.editHistory && data.editHistory.length > 0) {
          html += '<h6 class="mt-3">Edit History:</h6>';
          // latest first
          data.editHistory.slice().reverse().forEach(edit => {
            html += `
              <div class="border rounded p-2 mb-2 bg-light">
                <p class="mb-1"><strong>Edited on:</strong> ${new Date(edit.time).toLocaleString()}</p>
                <p class="mb-1"><strong>Edited by:</strong> ${edit.editedBy || 'Unknown'}</p>
                <p class="mb-1"><strong>Before:</strong></p>
                <ul class="small mb-1">
                  <li>Title: ${edit.before?.title || '-'}</li>
                  <li>Amount: ₹${edit.before?.amount || '-'}</li>
                  <li>Type: ${edit.before?.type || '-'}</li>
                </ul>
                <p class="mb-1"><strong>After:</strong></p>
                <ul class="small mb-0">
                  <li>Title: ${edit.after?.title || '-'}</li>
                  <li>Amount: ₹${edit.after?.amount || '-'}</li>
                  <li>Type: ${edit.after?.type || '-'}</li>
                </ul>
              </div>`;
          });
        } else {
          html += '<p class="text-muted mt-3">No edits yet.</p>';
        }
        historyList.innerHTML = html;
      } catch (err) {
        historyList.innerHTML = '<p class="text-danger">Failed to load history.</p>';
      }

      const modal = new bootstrap.Modal(document.getElementById('historyModal'));
      modal.show();
    }

    loadExpenses();
  </script>
</body>
</html>
