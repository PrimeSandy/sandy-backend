<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>E-Trax!</title>

<!-- Bootstrap (kept) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">

<!-- Firebase + Chart.js (kept) -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- NOTE: socket.io client is loaded dynamically from server as before -->

<style>
  /* ===========================
     THEME VARIABLES (dark + neon)
     =========================== */
  :root{
    --bg: #060606;
    --surface: #0f1113;
    --panel: #0b0b0b;
    --muted: #9aa3ab;
    --text: #e6f1ef;
    --accent: #00e6c3; /* neon teal */
    --accent-2: #ffc857; /* warm amber for highlights */
    --danger: #ff3b30;
    --glass: rgba(255,255,255,0.03);
    --radius: 14px;
    --card-shadow: 0 8px 28px rgba(0,0,0,0.6);
    --glass-border: 1px solid rgba(255,255,255,0.04);
    --max-width: 1100px;
    --fs-sm: 0.9rem;
    --fs-base: 1rem;
    --fs-lg: 1.125rem;
  }

  /* ========= Reset & base ========= */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg, #050506 0%, #0b0b0b 100%);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    font-size:var(--fs-base);
    line-height:1.45;
  }
  a{color:inherit;text-decoration:none}
  img{max-width:100%;height:auto;display:block}

  /* ========== Page container ========== */
  .page {
    max-width: var(--max-width);
    margin: 18px auto;
    padding: 18px;
  }

  /* ========== Top bar / header ========== */
  header.app-header{
    position: sticky;
    top: 12px;
    z-index: 60;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius: 12px;
    padding: 12px 14px;
    display:flex;
    gap:12px;
    align-items:center;
    box-shadow: var(--card-shadow);
    border: var(--glass-border);
  }
  .brand {
    display:flex; align-items:center; gap:12px;
  }
  .logo {
    width:46px; height:46px; border-radius:10px;
    background: linear-gradient(135deg, rgba(0,230,195,0.18), rgba(0,230,195,0.35));
    display:inline-grid; place-items:center; color:var(--accent); font-weight:800; font-family:"Poppins";
    box-shadow: 0 6px 18px rgba(0,230,195,0.04), inset 0 -6px 12px rgba(0,0,0,0.3);
  }
  .project-name { font-family:"Poppins"; font-weight:700; font-size:1.05rem; color:var(--text); margin:0 }
  .project-sub { font-size:0.82rem; color:var(--muted); margin:0; }

  .header-center { flex:1; text-align:center; }
  #typingHeader { color:var(--accent-2); font-weight:600; font-size:0.95rem; min-height:1.3rem; }

  .header-actions { display:flex; gap:10px; align-items:center; }

  .btn-accent{
    background: linear-gradient(90deg, var(--accent), #15d0a0);
    color:#002017;
    border: none;
    font-weight:700;
    padding: 8px 12px;
    border-radius:10px;
    box-shadow: 0 8px 20px rgba(0,230,195,0.08);
  }
  .btn-accent-outline{
    background:transparent;
    color:var(--accent);
    border:1px solid rgba(0,230,195,0.12);
    padding:7px 10px;
    border-radius:9px;
    font-weight:600;
  }
  .nav-link-style{ color:var(--muted); padding:6px 8px; border-radius:8px; font-weight:600 }
  .nav-link-style:hover{ background:rgba(255,255,255,0.02); color:var(--text) }

  /* ========== Layout grid ========== */
  .grid {
    display:grid;
    grid-template-columns: 1fr;
    gap:18px;
    margin-top:16px;
  }

  /* larger screens */
  @media(min-width:900px){
    .grid { grid-template-columns: 2fr 420px; align-items:start; }
  }

  /* ========== Panels / cards ========== */
  .card-panel {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));
    border-radius: var(--radius);
    padding:16px;
    border: var(--glass-border);
    box-shadow: var(--card-shadow);
  }

  .card-header {
    display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px;
  }
  .card-title { font-weight:700; font-family:"Poppins"; color:var(--text); margin:0; font-size:1.02rem; }
  .card-sub { font-size:0.9rem; color:var(--muted); }

  /* table container */
  .table-container {
    overflow:auto;
    border-radius:12px;
    padding:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.008));
    border: 1px solid rgba(255,255,255,0.02);
  }
  table.table thead {
    background: linear-gradient(90deg, rgba(0,230,195,0.12), rgba(255,200,87,0.06));
    color:#001917; font-weight:700;
  }
  table.table tbody tr td { vertical-align:middle; }

  .muted { color:var(--muted); }
  .small-muted { font-size:0.85rem; color:var(--muted); }

  /* form styling adjustments - keep IDs & inputs same */
  .form-control, .form-select { background: transparent; color:var(--text); border-radius:10px; border:1px solid rgba(255,255,255,0.04); padding:10px; }
  .form-control::placeholder { color: rgba(230,241,239,0.25); }
  .card.bg-dark.text-white { background: transparent; border: none; box-shadow: none; padding:0; }

  /* budget progress */
  .progress { height:18px; background: rgba(255,255,255,0.03); border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,0.02) }
  .progress-bar { font-weight:700; color:#001917; }

  /* activity log */
  #activityLog { margin-top:8px; }
  .activity-item { padding:10px 0; border-bottom:1px dashed rgba(255,255,255,0.03); color:var(--muted) }
  .field-changed { color: var(--accent-2); font-weight:800; }

  /* analytics canvases */
  canvas { width:100% !important; height:260px !important; }

  /* modals (custom dark) */
  #aboutModal, #historyModal {
    display:none;
    position:fixed;
    inset:0;
    z-index:9999;
    background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.75));
    padding:24px;
    box-sizing:border-box;
    align-items:center;
    justify-content:center;
  }
  .modal-content-custom{
    max-width:920px;
    margin:auto;
    background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
    padding:22px;
    border-radius:16px;
    border: 1px solid rgba(255,255,255,0.02);
    box-shadow: 0 20px 60px rgba(0,0,0,0.7);
  }
  .history-card { max-width:920px; margin:auto; background:transparent; padding:12px; border-radius:12px; }

  .history-entry { padding:12px; border-radius:8px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.008)); margin-bottom:10px; border: 1px solid rgba(255,255,255,0.02); }
  pre { background: #070707; color:var(--muted); padding:10px; border-radius:8px; overflow:auto; }

  /* footer */
  footer.site-footer {
    margin-top:18px;
    padding:16px;
    text-align:center;
    color:var(--muted);
    font-size:0.92rem;
  }

  /* small screens tweaks */
  @media(max-width:899px){
    header.app-header{ flex-direction:column; align-items:stretch; gap:10px; }
    .header-center{ text-align:left; }
    .grid { grid-template-columns:1fr; }
    canvas { height:220px !important; }
  }

  /* micro interactions */
  button, .btn { transition: transform 120ms ease, box-shadow 160ms ease; }
  button:active { transform: translateY(1px) }
</style>
</head>
<body>

  <div class="page">

    <!-- HEADER -->
    <header class="app-header">
      <div class="brand">
        <div class="logo">ET</div>
        <div>
          <div class="project-name">E-TRAX</div>
          <div class="project-sub">Expense & Tracking • Parallel Tracking Sense</div>
        </div>
      </div>

      <div class="header-center">
        <div id="typingHeader" class="small-muted">Manage expenses — fast, private, and in real-time</div>
      </div>

      <div class="header-actions">
        <!-- keep login/logout IDs unchanged so existing JS works -->
        <div id="userNameDisplay" class="small-muted" style="min-width:130px;text-align:right"></div>
        <div>
          <button id="googleLoginBtn" class="btn btn-accent" style="display:block;">Login with Google</button>
          <button id="googleLogoutBtn" class="btn btn-accent-outline" style="display:none;">Logout</button>
        </div>
      </div>
    </header>

    <!-- MAIN GRID -->
    <div class="grid">

      <!-- LEFT: Main area -->
      <div>

        <!-- BUDGET CARD -->
        <div id="budgetCard" class="card-panel" style="display:none;">
          <div class="card-header">
            <div>
              <div class="card-title" style="color:var(--accent-2)">Budget Limit</div>
              <div class="card-sub">Set and track a monthly budget for your expenses</div>
            </div>
            <div>
              <button id="resetBudgetBtn" class="btn btn-outline-danger btn-sm">Reset</button>
            </div>
          </div>

          <div class="row g-2 align-items-center">
            <div class="col-12 col-md-5">
              <input type="number" id="budgetInput" class="form-control" placeholder="Enter budget amount (e.g. 5000)">
            </div>
            <div class="col-auto">
              <button id="saveBudgetBtn" class="btn btn-accent">Save Budget</button>
            </div>
            <div class="col text-end small-muted">
              <div id="budgetStatusText" style="font-weight:700;color:var(--text)">No budget set</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <div id="budgetBar" class="mb-2">
              <div id="budgetProgress" class="progress" style="width:100%">
                <div id="budgetProgressBar" class="progress-bar" role="progressbar" style="width:0%"></div>
              </div>
            </div>
            <div id="budgetAlerts" style="min-height:22px"></div>
          </div>
        </div>

        <!-- Expense Form (keep IDs) -->
        <div id="expenseFormContainer" style="display:none; margin-top:12px;">
          <div class="card-panel">
            <div class="card-header">
              <div>
                <div class="card-title">Add / Edit Expense</div>
                <div class="card-sub">Fill details and press <span style="font-weight:700">Confirm</span></div>
              </div>
              <div class="small-muted" id="formHelper"></div>
            </div>

            <div class="card-body" style="padding:0">
              <div class="card bg-dark text-white mb-0" style="background:transparent;border:none;padding:0">
                <div class="card-body" style="padding:0">
                  <form id="expenseForm" class="row g-3">
                    <input type="hidden" id="editId">
                    <div class="col-md-6">
                      <label for="name" class="form-label small-muted">Name</label>
                      <input type="text" id="name" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                      <label for="amount" class="form-label small-muted">Amount</label>
                      <input type="number" id="amount" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                      <label for="type" class="form-label small-muted">Type</label>
                      <select id="type" class="form-select" required>
                        <option value="">Choose one...</option>
                        <option value="Card">Card</option>
                        <option value="Cash">Cash</option>
                        <option value="Gpay/Paytm">Gpay/Paytm</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="description" class="form-label small-muted">Description</label>
                      <input type="text" id="description" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                      <label for="date" class="form-label small-muted">Date</label>
                      <input type="date" id="date" class="form-control" required>
                    </div>
                    <div class="col-12 d-flex justify-content-between mt-3">
                      <button type="reset" class="btn btn-outline-danger">Clear</button>
                      <button type="submit" class="btn btn-accent">Confirm</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Table (kept container id) -->
        <div id="tableContainer" class="table-container" style="margin-top:12px;"></div>

        <!-- Activity Log -->
        <div id="activityLog" style="display:none; margin-top:12px;">
          <div class="card-panel">
            <div class="card-header">
              <div>
                <div class="card-title" style="color:var(--accent-2)">Recent Activity</div>
                <div class="card-sub">Latest creations and edits</div>
              </div>
            </div>
            <div id="activityItems" style="margin-top:6px;"></div>
          </div>
        </div>

      </div>

      <!-- RIGHT: Analytics / small widgets -->
      <aside>
        <div class="card-panel">
          <div class="card-header">
            <div>
              <div class="card-title">📊 Expense Analytics</div>
              <div class="card-sub">Visual summaries</div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div style="margin-bottom:12px;">
              <canvas id="lineChart"></canvas>
            </div>
            <div style="margin-bottom:6px;">
              <canvas id="pieChart"></canvas>
            </div>
            <div id="analyticsBadge" class="small-muted text-center" style="margin-top:8px;"></div>
          </div>
        </div>

        <!-- Small quick help card -->
        <div class="card-panel" style="margin-top:14px;">
          <div class="card-title">Quick Tips</div>
          <div class="card-sub small-muted" style="margin-top:8px">
            • Use <strong>Confirm</strong> to save or edit. <br>
            • Click <strong>History</strong> to view before/after. <br>
            • Reset budget to start fresh.
          </div>
        </div>
      </aside>

    </div> <!-- grid -->

  </div> <!-- page -->

  <!-- ABOUT MODAL -->
  <div id="aboutModal">
    <div class="modal-content-custom">
      <h2 style="color:var(--accent-2);text-align:center;margin-top:0">About Parallel Tracking Sense</h2>
      <p style="color:var(--text)"><strong>Parallel Tracking Sense</strong> helps you <strong>track your daily expenses</strong> and manage your budget efficiently.</p>
      <h4 style="color:var(--accent-2);">💡 Purpose</h4>
      <p style="color:var(--muted)">Record, categorize, and analyze your spending patterns easily. This interface works across desktop and mobile devices.</p>
      <div style="text-align:center;margin-top:12px;">
        <button id="closeAbout" class="btn btn-accent">Close</button>
      </div>
    </div>
  </div>

  <!-- HISTORY MODAL -->
  <div id="historyModal">
    <div class="modal-content-custom history-card" id="historyContent">
      <h4 id="historyTitle" style="color:var(--accent-2); margin-top:0">History</h4>
      <div id="historyList"></div>
      <div style="text-align:right; margin-top:12px;">
        <button id="closeHistoryBtn" class="btn btn-outline-secondary">Close</button>
      </div>
    </div>
  </div>

  <!-- MESSAGE BOX -->
  <div id="msgBox" style="position: fixed; top: 20px; right: 20px; background-color: #198754; color: white; padding: 10px 20px; border-radius: 10px; display: none; z-index: 9999;"></div>

  <!-- ORIGINAL SCRIPT (kept exactly; IDs & functions unchanged) -->
  <script>
  /* --------------------------
    Config & globals
  ---------------------------*/
  // BASE URL for your backend
  const BASE_URL = window.location.hostname.includes("localhost")
    ? "http://localhost:3000"
    : "https://sandy-backend2-0.onrender.com";

  // socket loader flag
  let socketIoLoaded = false;
  let socket = null;

  // Firebase init
  const firebaseConfig = {
    apiKey: "AIzaSyDgeOmsWD36spVcXw9QVSbUs4nmx-iXGak",
    authDomain: "ptspro-31997.firebaseapp.com",
    projectId: "ptspro-31997",
    storageBucket: "ptspro-31997.appspot.com",
    messagingSenderId: "191965542623",
    appId: "1:191965542623:web:b461ceedfc3a773267516a",
    measurementId: "G-6LNC29KRQF"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  let currentUserUid = null;
  let currentBudgetAmount = 0; // <-- important global

  /* --------------------------
    DOM refs
  ---------------------------*/
  const loginBtn = document.getElementById("googleLoginBtn");
  const logoutBtn = document.getElementById("googleLogoutBtn");
  const loginContainer = document.getElementById("loginContainer");
  const expenseFormContainer = document.getElementById("expenseFormContainer");
  const tableContainer = document.getElementById("tableContainer");
  const msgBox = document.getElementById("msgBox");
  const userNameDisplay = document.getElementById("userNameDisplay");
  const analyticsContainer = document.getElementById("analyticsContainer");
  const budgetCard = document.getElementById("budgetCard");
  const budgetInput = document.getElementById("budgetInput");
  const saveBudgetBtn = document.getElementById("saveBudgetBtn");
  const resetBudgetBtn = document.getElementById("resetBudgetBtn");
  const budgetProgressBar = document.getElementById("budgetProgressBar");
  const budgetStatusText = document.getElementById("budgetStatusText");
  const budgetAlerts = document.getElementById("budgetAlerts");
  const analyticsBadge = document.getElementById("analyticsBadge");
  const aboutLink = document.getElementById("aboutLink");
  const aboutModal = document.getElementById("aboutModal");
  const closeAbout = document.getElementById("closeAbout");
  const historyModal = document.getElementById("historyModal");
  const historyList = document.getElementById("historyList");
  const historyTitle = document.getElementById("historyTitle");
  const closeHistoryBtn = document.getElementById("closeHistoryBtn");
  const form = document.getElementById("expenseForm");
  const editId = document.getElementById("editId");

  /* --------------------------
    Helpers
  ---------------------------*/
  function showMessage(msg, duration=2000){
    msgBox.innerText = msg;
    msgBox.style.display = "block";
    setTimeout(()=> msgBox.style.display = "none", duration);
  }

  function formatDateString(d){
    if(!d) return "—";
    const dt = (typeof d === 'string' || typeof d === 'number') ? new Date(d) : d;
    if(isNaN(dt.getTime())) return String(d);
    const opts = { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' };
    return dt.toLocaleString('en-GB', opts);
  }

  /* --------------------------
    Load socket.io client then connect
  ---------------------------*/
  (function loadSocketIo(){
    const s = document.createElement('script');
    s.src = `${BASE_URL.replace(/\/$/,'')}/socket.io/socket.io.js`;
    s.onload = ()=> { console.log("socket.io client loaded"); socketIoLoaded = true; if(currentUserUid) connectSocket(); };
    s.onerror = ()=> { console.warn("socket.io client failed to load"); socketIoLoaded = false; };
    document.head.appendChild(s);
  })();

  function connectSocket(retries = 0){
    try {
      if(typeof io === 'undefined'){
        if(retries < 5) setTimeout(()=> connectSocket(retries+1), 800);
        else console.warn("socket.io client not available (tried retries)");
        return;
      }
      // prevent duplicate sockets
      if(socket && socket.connected) return;
      socket = io(BASE_URL);
      socket.on("connect", ()=> {
        console.log("socket connected:", socket.id);
        if(currentUserUid) socket.emit("join", currentUserUid);
      });
      socket.on("expenses-changed", (payload)=> {
        console.log("expenses-changed", payload);
        loadData(); // reload
      });
      socket.on("budget-changed", (payload) => {
        console.log("budget-changed", payload);
        fetchBudget();
      });
    } catch(err){ console.error("Socket error", err); }
  }

  /* --------------------------
    Auth & UI toggles
  ---------------------------*/
  function toggleLoginState(isLoggedIn){
    // loginContainer may not exist visually (we replaced top buttons) — keep behaviour safe
    if(document.getElementById("loginContainer")){
      loginContainer.style.display = isLoggedIn ? "none" : "block";
    }
    logoutBtn.style.display = isLoggedIn ? "inline-block" : "none";
    expenseFormContainer.style.display = isLoggedIn ? "block" : "none";
    document.querySelector("header").style.display = isLoggedIn ? "flex" : "none";
    budgetCard.style.display = isLoggedIn ? "block" : "none";
    analyticsContainer.style.display = isLoggedIn ? analyticsContainer.style.display : "none";
    document.getElementById("activityLog").style.display = isLoggedIn ? "block" : "none";
  }

  auth.onAuthStateChanged(async user=>{
    if(user){
      currentUserUid = user.uid;
      toggleLoginState(true);
      userNameDisplay.textContent = user.displayName || "User";
      if(socketIoLoaded) connectSocket();
      else connectSocket(); // try connecting with retries
      await loadData();
      await fetchBudget();
    } else {
      currentUserUid = null;
      toggleLoginState(false);
      tableContainer.innerHTML = "<p class='text-muted'>Login to view your expenses</p>";
      analyticsContainer.style.display = "none";
      userNameDisplay.textContent = "";
      clearBudgetUI();
      if(socket){ socket.disconnect(); socket = null; }
    }
  });

  /* Login / Logout */
  loginBtn.addEventListener("click", async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      const result = await auth.signInWithPopup(provider);
      currentUserUid = result.user.uid;
      toggleLoginState(true);
      loadData();
      userNameDisplay.textContent = result.user.displayName || "User";
      showMessage("✅ Logged in successfully", 2000);
      fetchBudget();
    } catch(err){ console.error(err); showMessage("❌ Login failed",2000); }
  });

  logoutBtn.addEventListener("click", async () => {
    try {
      await auth.signOut();
      currentUserUid = null;
      toggleLoginState(false);
      tableContainer.innerHTML = "<p class='text-muted'>Login to view your expenses</p>";
      analyticsContainer.style.display = "none";
      userNameDisplay.textContent = "";
      clearBudgetUI();
      if(socket){ socket.disconnect(); socket = null; }
      showMessage("✅ Logged out successfully",2000);
    } catch(err){ console.error(err); showMessage("❌ Logout failed",2000); }
  });

  /* --------------------------
    Expense form submit (create + update)
  ---------------------------*/
  form.addEventListener("submit", async e=>{
    e.preventDefault();
    if(!currentUserUid) return showMessage("Login first");
    const payload = {
      uid: currentUserUid,
      name: document.getElementById("name").value.trim(),
      amount: document.getElementById("amount").value.trim(),
      type: document.getElementById("type").value,
      description: document.getElementById("description").value.trim(),
      date: document.getElementById("date").value
    };

    try {
      const url = editId.value ? `${BASE_URL}/update/${editId.value}` : `${BASE_URL}/submit`;
      // include editorName when updating
      if(editId.value){
        payload.editorName = (auth.currentUser && auth.currentUser.displayName) ? auth.currentUser.displayName : null;
      }
      const res = await fetch(url, { method: editId.value ? "PUT" : "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload) });
      const result = await res.json();
      if(!res.ok) throw new Error(result.message || "Server error");
      showMessage(result.message || "Saved");
      editId.value = "";
      form.reset();
      await loadData();
      await fetchBudget();
    } catch(err){ console.error(err); showMessage("❌ Failed to submit/edit expense",2500); }
  });

  /* --------------------------
    Budget functions
  ---------------------------*/
  async function saveBudgetToServer(amount){
    if(!currentUserUid) return;
    try {
      const res = await fetch(`${BASE_URL}/setBudget`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ uid: currentUserUid, amount: parseFloat(amount) || 0 }) });
      const r = await res.json();
      if(res.ok) showMessage(r.message || "Budget saved");
      else showMessage(r.message || "Failed to save budget");
      await fetchBudget();
    } catch(err){ console.error(err); showMessage("❌ Failed to save budget",2000); }
  }

  async function fetchBudget(){
    if(!currentUserUid) return clearBudgetUI();
    try {
      const res = await fetch(`${BASE_URL}/getBudget?uid=${currentUserUid}`);
      if(!res.ok) return clearBudgetUI();
      const r = await res.json();
      if(!r || typeof r.amount === "undefined" || r.amount === 0){
        currentBudgetAmount = 0;
        clearBudgetUI();
        return;
      }
      currentBudgetAmount = parseFloat(r.amount) || 0;

      // compute current total from expenses and update UI
      const expensesRes = await fetch(`${BASE_URL}/users?uid=${currentUserUid}`);
      const arr = await expensesRes.json();
      let totalAmount = 0;
      if(Array.isArray(arr)) arr.forEach(x=> totalAmount += parseFloat(x.amount)||0);
      updateBudgetUI(currentBudgetAmount, totalAmount);
      budgetInput.value = currentBudgetAmount;
    } catch(err){ console.error(err); clearBudgetUI(); }
  }

  function clearBudgetUI(){
    budgetInput.value = "";
    if(budgetProgressBar) budgetProgressBar.style.width = "0%";
    if(budgetProgressBar) budgetProgressBar.className = "progress-bar";
    budgetStatusText.innerText = "No budget set";
    budgetAlerts.innerHTML = "";
    currentBudgetAmount = 0;
    analyticsBadge.innerText = "";
  }

  function updateBudgetUI(budgetAmount, totalSpent){
    if(!budgetAmount || budgetAmount <= 0){
      clearBudgetUI();
      return;
    }
    const pct = (totalSpent / budgetAmount) * 100;
    const pctClamped = Math.min(Math.round(pct), 999);
    const widthPct = Math.min(pctClamped, 100);
    budgetProgressBar.style.width = widthPct + "%";
    budgetProgressBar.innerText = `${pctClamped}%`;

    budgetProgressBar.className = "progress-bar";
    if(pct >= 100){ budgetProgressBar.classList.add("bg-danger"); }
    else if(pct >= 80){ budgetProgressBar.classList.add("bg-warning"); }
    else { budgetProgressBar.classList.add("bg-success"); }

    budgetStatusText.innerText = `Budget: ₹${budgetAmount.toFixed(2)}  —  Spent: ₹${totalSpent.toFixed(2)}`;

    budgetAlerts.innerHTML = "";
    analyticsBadge.innerText = "";
    if(pct >= 100){
      const over = (totalSpent - budgetAmount);
      budgetAlerts.innerHTML = `<div class="text-danger" style="font-weight:700;">🚨 Budget exceeded! You spent ₹${over.toFixed(2)} over the limit.</div>`;
      analyticsBadge.innerHTML = `🚨 Over budget: ₹${over.toFixed(2)} (shown as red slice in chart)`;
    } else if(pct >= 80){
      budgetAlerts.innerHTML = `<div class="text-warning" style="font-weight:700;">⚠️ You're at ${Math.round(pct)}% of your budget. Be careful!</div>`;
      analyticsBadge.innerHTML = `⚠️ Usage: ${Math.round(pct)}% of budget`;
    } else {
      analyticsBadge.innerHTML = `✅ Usage: ${Math.round(pct)}% of budget`;
    }
  }

  saveBudgetBtn.addEventListener("click", async () => {
    const val = parseFloat(budgetInput.value);
    if(!val || val <= 0){ showMessage("Enter valid budget amount"); return; }
    await saveBudgetToServer(val);
  });

  resetBudgetBtn.addEventListener("click", async () => {
    if(!currentUserUid) return;
    if(!confirm("Reset/delete your budget?")) return;
    try {
      const res = await fetch(`${BASE_URL}/setBudget`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ uid: currentUserUid, amount: 0, reset: true }) });
      const r = await res.json();
      if(res.ok) showMessage(r.message || "Budget reset");
      else showMessage(r.message || "Reset failed");
      clearBudgetUI();
    } catch(err){ console.error(err); showMessage("❌ Reset failed",2000); }
  });

  /* --------------------------
    Activity log & history helpers
  ---------------------------*/
  function buildActivityLog(allUsers){
    const log = [];
    allUsers.forEach(u => {
      if(u.createdAt) log.push({ type:'created', uid:u.uid, display:`${u.name} created`, date:u.createdAt, expenseId:u._id, by:u.uid });
      if(Array.isArray(u.editHistory)){
        u.editHistory.forEach(e=>{
          log.push({ type:'edited', expenseName:u.name, expenseId:u._id, editorName:e.editorName || e.editorUid || 'Unknown', date:e.date, before:e.before, after:e.after, editorUid:e.editorUid });
        });
      }
    });
    log.sort((a,b)=> new Date(b.date) - new Date(a.date));
    return log;
  }

  function renderActivityLog(allUsers){
    const itemsDiv = document.getElementById('activityItems');
    const container = document.getElementById('activityLog');
    const log = buildActivityLog(allUsers);
    itemsDiv.innerHTML = "";
    if(!log || log.length===0){ container.style.display = 'none'; return; }
    container.style.display = 'block';
    const limited = log.slice(0,20);
    limited.forEach(it=>{
      const div = document.createElement('div');
      div.className = "activity-item";
      if(it.type === 'created'){
        div.innerHTML = `<div><strong>${it.display}</strong> — ${formatDateString(it.date)}</div>`;
      } else {
        const changed = [];
        if(it.before && it.after){
          for(const k of Object.keys(it.before)) if(String(it.before[k]) !== String(it.after[k])) changed.push(k);
        }
        const fieldsText = changed.length ? `<span class="field-changed">${changed.join(', ')}</span>` : `<span class="text-muted">no fields</span>`;
        div.innerHTML = `<div><strong>${it.editorName}</strong> edited <strong>${it.expenseName || ''}</strong> — ${fieldsText} — ${formatDateString(it.date)}</div>`;
      }
      itemsDiv.appendChild(div);
    });
  }

  /* --------------------------
    Load data (main)
  ---------------------------*/
  async function loadData(){
    if(!currentUserUid) return;
    try{
      const res = await fetch(`${BASE_URL}/users?uid=${currentUserUid}`);
      if(!res.ok){
        const text = await res.text().catch(()=>"");
        throw new Error(`Failed to fetch users: ${res.status} ${text}`);
      }
      const users = await res.json();
      if(!Array.isArray(users) || users.length === 0){
        tableContainer.innerHTML = "<p class='text-muted'>No expenses yet.</p>";
        analyticsContainer.style.display = "none";
        document.getElementById('activityLog').style.display = 'none';
        const bRes = await fetch(`${BASE_URL}/getBudget?uid=${currentUserUid}`);
        if(bRes.ok){
          const b = await bRes.json();
          if(b && b.amount) updateBudgetUI(parseFloat(b.amount), 0);
        }
        return;
      }

      let html = `<table class="table table-striped table-bordered text-white"><thead><tr>
        <th>#</th><th>Name</th><th>Amount</th><th>Type</th><th>Description</th><th>Date</th><th>Edits</th><th>Last Edited</th><th>Action</th>
      </tr></thead><tbody>`;

      let totalAmount = 0;
      users.forEach((u,i)=>{
        totalAmount += parseFloat(u.amount) || 0;
        const editCount = u.editCount || 0;
        const lastEdited = u.updatedAt || u.createdAt || null;
        const actionBtn = `<button class="btn btn-warning btn-sm" onclick="editExpense('${u._id}')">Edit</button>`;
        const historyBtn = `<button class="btn btn-info btn-sm ms-1" onclick="viewHistory('${u._1d || u._id}')">History</button>`;
        html += `<tr>
          <td>${i+1}</td>
          <td>${u.name || ''}</td>
          <td>${u.amount}</td>
          <td>${u.type}</td>
          <td>${u.description}</td>
          <td>${u.date}</td>
          <td style="font-weight:700;">${editCount}</td>
          <td>${formatDateString(lastEdited)}</td>
          <td>${actionBtn}${historyBtn}</td>
        </tr>`;
      });

      html += `<tr style="background:linear-gradient(90deg, rgba(0,230,195,0.12), rgba(255,200,87,0.06)); color:#001917; font-weight:700;"><td colspan="2" class="text-end">Total</td><td colspan="7">${totalAmount.toFixed(2)}</td></tr>`;
      html += "</tbody></table>";
      tableContainer.innerHTML = html;

      analyticsContainer.style.display = "block";
      renderCharts(users);

      const bRes = await fetch(`${BASE_URL}/getBudget?uid=${currentUserUid}`);
      if(bRes.ok){
        const b = await bRes.json();
        if(b && b.amount && parseFloat(b.amount) > 0) updateBudgetUI(parseFloat(b.amount), totalAmount);
        else clearBudgetUI();
      }

      renderActivityLog(users);
    } catch(err){
      console.error(err);
      tableContainer.innerHTML = `<p class='text-danger'>Failed to load expenses. ${err.message ? ("(" + err.message + ")") : ""}</p>`;
    }
  }

  /* --------------------------
    Edit / History handlers (global)
  ---------------------------*/
  window.editExpense = async function(id){
    try{
      const res = await fetch(`${BASE_URL}/user/${id}`);
      if(!res.ok) throw new Error("Failed to fetch user");
      const user = await res.json();
      document.getElementById("name").value = user.name || "";
      document.getElementById("amount").value = user.amount || "";
      document.getElementById("type").value = user.type || "";
      document.getElementById("description").value = user.description || "";
      document.getElementById("date").value = user.date || "";
      editId.value = id;
      showMessage("✏ Edit mode enabled",2000);
      // scroll into view
      window.scrollTo({ top: 0, behavior: "smooth" });
    } catch(err){ console.error(err); showMessage("❌ Failed to fetch expense for editing.",2500); }
  };

  window.viewHistory = async function(id){
    try{
      const res = await fetch(`${BASE_URL}/user/${id}`);
      if(!res.ok) throw new Error("Failed to fetch history");
      const u = await res.json();
      historyTitle.innerText = `History for: ${u.name || 'Expense'}`;
      historyList.innerHTML = "";
      const createdHtml = `<div class="history-entry"><div><strong>Created:</strong> ${formatDateString(u.createdAt)} </div><div class="text-muted">Initial values.</div></div>`;
      historyList.insertAdjacentHTML('beforeend', createdHtml);
      const hist = Array.isArray(u.editHistory) ? u.editHistory.slice().reverse() : [];
      if(hist.length === 0){
        historyList.insertAdjacentHTML('beforeend', `<div class="history-entry"><div class="text-muted">No edits yet.</div></div>`);
      } else {
        hist.forEach(h=>{
          const changedFields = [];
          if(h.before && h.after){
            Object.keys(h.before).forEach(k=>{
              if(String(h.before[k]) !== String(h.after[k])) changedFields.push(k);
            });
          }
          const changedText = changedFields.length ? `<div>Changed: <span class="field-changed">${changedFields.join(', ')}</span></div>` : `<div class="text-muted">No field differences detected</div>`;
          const editor = h.editorName || h.editorUid || "Unknown";
          const entryHtml = `<div class="history-entry">
            <div><strong>${editor}</strong> — ${formatDateString(h.date)}</div>
            ${changedText}
            <details style="margin-top:8px;">
              <summary style="cursor:pointer">Show before / after</summary>
              <pre style="background:#0b0b0b;padding:10px;border-radius:6px;margin-top:8px;">Before: ${JSON.stringify(h.before,null,2)}\n\nAfter: ${JSON.stringify(h.after,null,2)}</pre>
            </details>
          </div>`;
          historyList.insertAdjacentHTML('beforeend', entryHtml);
        });
      }
      historyModal.style.display = "block";
    } catch(err){ console.error(err); showMessage("❌ Failed to load history",2000); }
  };

  /* --------------------------
    Charts
  ---------------------------*/
  function renderCharts(users){
    const dates = {};
    const types = {};
    let totalAmount = 0;

    users.forEach(u=>{
      const date = u.date || "Unknown";
      const amount = parseFloat(u.amount) || 0;
      totalAmount += amount;
      dates[date] = (dates[date] || 0) + amount;
      const typeKey = (u.type && u.type.length) ? u.type : 'Other';
      types[typeKey] = (types[typeKey] || 0) + amount;
    });

    const overAmount = currentBudgetAmount && totalAmount > currentBudgetAmount ? (totalAmount - currentBudgetAmount) : 0;
    if(overAmount > 0){
      types[`Over Budget (₹${overAmount.toFixed(2)})`] = overAmount;
    }

    // Line Chart
    const lineCtx = document.getElementById('lineChart').getContext('2d');
    if(window.lineChartInstance) window.lineChartInstance.destroy();
    window.lineChartInstance = new Chart(lineCtx, {
      type: 'line',
      data: {
        labels: Object.keys(dates),
        datasets: [{
          label: 'Total Expense',
          data: Object.values(dates),
          borderColor: '#00e6c3',
          backgroundColor: 'rgba(0,230,195,0.12)',
          fill: true,
          tension: 0.3
        }]
      },
      options: { scales: { y: { beginAtZero:true, ticks: { color: '#cfd9d6' }, grid: { color: 'rgba(255,255,255,0.03)' } }, x: { ticks: { color: '#cfd9d6' }, grid: { color: 'rgba(255,255,255,0.02)' } } } }
    });

    // Pie Chart
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    if(window.pieChartInstance) window.pieChartInstance.destroy();
    const labels = Object.keys(types);
    const values = Object.values(types);
    const baseColors = ['#00e6c3','#ffc857','#8bc34a','#e91e63','#9c27b0','#3f51b5','#009688'];
    const bgColors = labels.map(l => l.startsWith("Over Budget") ? '#ff3b30' : baseColors.shift() || '#607d8b');

    window.pieChartInstance = new Chart(pieCtx, {
      type: 'pie',
      data: { labels, datasets: [{ data: values, backgroundColor: bgColors }] },
      options: { plugins: { legend: { labels: { color: '#cfd9d6' } } } }
    });

    if(overAmount > 0) analyticsBadge.innerText = `🚨 Over budget: ₹${overAmount.toFixed(2)} — shown as red slice in chart.`;
    else if(currentBudgetAmount > 0) analyticsBadge.innerText = `✅ Within budget: Budget ₹${currentBudgetAmount.toFixed(2)}, Spent ₹${totalAmount.toFixed(2)}.`;
    else analyticsBadge.innerText = "";
  }

  /* --------------------------
    UI actions for modals
  ---------------------------*/
  // aboutLink may not exist as visible anchor; keep handler safe
  if(aboutLink) aboutLink.addEventListener('click', e=>{ e.preventDefault(); aboutModal.style.display = 'flex'; });
  if(closeAbout) closeAbout.addEventListener('click', ()=> aboutModal.style.display = 'none');
  window.addEventListener('click', e=> { if(e.target === aboutModal) aboutModal.style.display='none'; if(e.target === historyModal) historyModal.style.display='none'; });
  if(closeHistoryBtn) closeHistoryBtn.addEventListener('click', ()=> historyModal.style.display='none');

  </script>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div style="display:flex; flex-direction:column; align-items:center; gap:6px;">
      <p style="margin:0;color:var(--muted)">Developed by <strong style="color:var(--accent);">Prime Sandy</strong></p>
      <p style="margin:0;color:var(--muted)">Email: <a href="mailto:santhoshgowtham777@gmail.com" style="color:var(--accent); text-decoration:none;">santhoshgowtham777@gmail.com</a></p>
      <p style="margin:0;color:var(--muted)">&copy; 2025 E-Trax. All rights reserved.</p>
    </div>
  </footer>

</body>
</html>
