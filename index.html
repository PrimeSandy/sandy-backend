<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ================= BASIC SEO ================= -->
    <title>E-TRAX | Smart Expense Tracker for Daily Budget Management</title>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta name="description" content="E-TRAX is a smart expense tracker to manage daily income and expenses with analytics, Firebase login, secure cloud storage, and budget tracking." />
    <meta name="keywords" content="expense tracker, expense tracker app, expense tracker web app, daily expense tracker, budget tracker, budget management app, money manager, personal finance tracker, finance management app, income and expense tracker, expense tracker for students, expense tracker for professionals, smart expense tracker, E-TRAX expense tracker, AlphaPrime expense tracker, alphaprime.co.in" />

    <meta name="author" content="AlphaPrime" />
    <meta name="robots" content="index, follow" />

    <!-- ================= CANONICAL ================= -->
    <link rel="canonical" href="https://www.alphaprime.co.in/" />

    <!-- ================= OPEN GRAPH ================= -->
    <meta property="og:title" content="E-TRAX | Smart Expense Tracker" />
    <meta property="og:description" content="Track your daily expenses, set budgets, and analyze spending with E-TRAX ‚Äì a secure smart expense tracker." />
    <meta property="og:url" content="https://www.alphaprime.co.in/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://www.alphaprime.co.in/e.png" />

    <!-- ================= TWITTER CARD ================= -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="E-TRAX | Smart Expense Tracker" />
    <meta name="twitter:description" content="Manage daily expenses and budgets easily with E-TRAX." />
    <meta name="twitter:image" content="https://www.alphaprime.co.in/e.png" />

    <!-- ================= FAVICONS ================= -->
    <link rel="icon" href="EtraxPub.jpg" type="image/png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <!-- ================= PWA ================= -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#2563eb" />

    <!-- ================= FONTS & CSS ================= -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- ================= JS LIBS ================= -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ================= STRUCTURED DATA ================= -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "E-TRAX",
        "url": "https://www.alphaprime.co.in/",
        "logo": "https://www.alphaprime.co.in/logo.png"
    }
    </script>

    <style>
        :root {
            /* Professional Dark Blue Theme - 90% dark blue, 10% white */
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary: #f59e0b;
            --accent: #8b5cf6;
            --background: #0f172a; /* Dark blue 90% */
            --card-bg: #1e293b;
            --surface: #334155;
            --text: #ffffff; /* White 10% */
            --text-light: #e2e8f0;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            --radius: 12px;
        }

        [data-theme="light"] {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary: #dc2626;
            --background: #ffffff; /* White 10% */
            --card-bg: #f8fafc;
            --surface: #e2e8f0;
            --text: #0f172a; /* Dark blue 90% */
            --text-light: #334155;
            --text-muted: #64748b;
            --border: rgba(15, 23, 42, 0.1);
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        [data-theme="professional"] {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #60a5fa;
            --secondary: #f59e0b;
            --background: #0f172a;
            --card-bg: #1e293b;
            --surface: #334155;
            --text: #ffffff;
            --text-light: #e2e8f0;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.15);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* ========== TYPOGRAPHY ========== */
        body {
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 400;
            line-height: 1.6;
            background-color: var(--background);
            color: var(--text);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: "Space Grotesk", sans-serif;
            font-weight: 600;
            line-height: 1.2;
            letter-spacing: -0.01em;
        }

        /* Desktop font sizes */
        h1 { font-size: 2.25rem; }  /* 36px */
        h2 { font-size: 1.875rem; } /* 30px */
        h3 { font-size: 1.5rem; }   /* 24px */
        h4 { font-size: 1.25rem; }  /* 20px */
        h5 { font-size: 1.125rem; } /* 18px */
        h6 { font-size: 1rem; }     /* 16px */
        body { font-size: 0.9375rem; } /* 15px */

        /* Mobile font sizes */
        @media (max-width: 768px) {
            h1 { font-size: 1.875rem; }  /* 30px */
            h2 { font-size: 1.5rem; }    /* 24px */
            h3 { font-size: 1.25rem; }   /* 20px */
            h4 { font-size: 1.125rem; }  /* 18px */
            h5 { font-size: 1rem; }      /* 16px */
            h6 { font-size: 0.9375rem; } /* 15px */
            body { font-size: 0.875rem; } /* 14px */
        }

        /* ========== BACKGROUND ANIMATION ========== */
        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            opacity: 0.6;
            pointer-events: none;
        }

        .gradient-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--background) 0%, rgba(15, 23, 42, 0.95) 100%);
            z-index: -1;
            pointer-events: none;
        }

        /* ========== LOGIN VIEW ========== */
        .login-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 24px;
            position: relative;
        }

        .login-card {
            width: 100%;
            max-width: 440px;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 48px 32px;
            text-align: center;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            position: relative;
            z-index: 1;
        }

        .login-card h1 {
            font-size: 2.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .login-card p {
            color: var(--text-light);
            margin-bottom: 32px;
            font-size: 1rem;
            font-weight: 400;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            background: white;
            color: #1a1a1a;
            border-radius: 10px;
            padding: 14px 20px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            font-size: 0.9375rem;
            margin-bottom: 20px;
        }

        .google-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .google-btn img {
            width: 20px;
            height: 20px;
        }

        .note {
            color: var(--text-muted);
            font-size: 0.8125rem;
            margin-top: 16px;
            font-weight: 400;
        }

        .developer {
            margin-top: 20px;
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .developer strong {
            color: var(--primary);
            font-weight: 600;
        }

        /* ========== HEADER ========== */
        .main-header {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .brand-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .brand-section h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .typing {
            font-size: 0.875rem;
            color: var(--secondary);
            font-weight: 500;
            min-height: 1.2rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        #userNameDisplay {
            color: var(--text-light);
            font-weight: 500;
            font-size: 0.9375rem;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-links a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-links a:hover {
            color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 16px;
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        #googleLogoutBtn {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            font-weight: 500;
            border-radius: 8px;
            padding: 8px 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #googleLogoutBtn:hover {
            background: var(--danger);
            color: white;
            transform: translateY(-2px);
        }

        /* ========== MAIN CONTAINER ========== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 20px;
        }

        /* ========== CARDS ========== */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            background: rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            color: var(--primary);
            font-weight: 600;
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-body {
            padding: 24px;
        }

        /* ========== BUDGET CARD ========== */
        #budgetCard {
            display: none;
        }

        #budgetBar {
            height: 22px;
            border-radius: 11px;
            overflow: hidden;
            background: var(--surface);
            margin-top: 12px;
        }

        #budgetBar .progress {
            height: 22px;
            line-height: 22px;
            font-weight: 600;
            transition: width 0.5s ease;
            font-size: 0.75rem;
        }

        #budgetStatusText {
            font-weight: 600;
            color: var(--text) !important;
        }

        /* ========== FORMS ========== */
        .form-control, .form-select {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            padding: 10px 14px;
            transition: all 0.3s ease;
            font-size: 0.9375rem;
        }

        .form-control:focus, .form-select:focus {
            background: var(--card-bg);
            border-color: var(--primary);
            color: var(--text);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-label {
            color: var(--text-light);
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 0.875rem;
        }

        /* ========== BUTTONS ========== */
        .btn {
            border-radius: 8px;
            font-weight: 500;
            padding: 10px 20px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 0.9375rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: 1px solid var(--primary-dark);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: black;
            font-weight: 500;
        }

        .btn-outline-danger {
            border-color: var(--danger);
            color: var(--danger);
            background: transparent;
        }

        .btn-outline-danger:hover {
            background: var(--danger);
            color: white;
        }

        .btn-info {
            background: var(--primary);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8125rem;
        }

        /* ========== TABLES ========== */
        .table-container {
            margin-top: 24px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        table {
            color: var(--text) !important;
            font-size: 0.875rem;
            margin-bottom: 0;
            width: 100%;
        }

        table thead {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        table tbody tr {
            transition: all 0.3s ease;
            color: var(--text) !important;
        }

        table tbody tr:hover {
            background-color: rgba(37, 99, 235, 0.05);
        }

        /* Mobile card view for expenses */
        .expense-card {
            transition: all 0.3s ease;
            border-radius: var(--radius);
            color: var(--text);
            background: var(--card-bg);
            border: 1px solid var(--border);
        }

        .expense-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .expense-details {
            font-size: 0.875rem;
            color: var(--text-light);
            font-weight: 400;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            background: var(--primary);
        }

        /* ========== ANALYTICS ========== */
        #analyticsContainer {
            display: none;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 24px;
        }

        /* ========== MODALS ========== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: var(--text);
            z-index: 9999;
            overflow: auto;
            padding: 50px 20px;
            box-sizing: border-box;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            max-width: 800px;
            margin: auto;
            background: var(--card-bg);
            padding: 32px;
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            animation: modalFadeIn 0.3s ease;
            border: 1px solid var(--border);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== MESSAGE BOX ========== */
        #msgBox {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--success);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            display: none;
            z-index: 9999;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: slideInRight 0.3s ease;
            font-weight: 500;
            max-width: 400px;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ========== FOOTER ========== */
        footer {
            background: var(--card-bg);
            color: var(--text-muted);
            text-align: center;
            padding: 32px 20px;
            border-top: 1px solid var(--border);
            margin-top: 48px;
            font-size: 0.8125rem;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.8125rem;
        }

        .footer-links a:hover {
            color: var(--secondary);
        }

        .blinking-name {
            color: var(--primary);
            animation: blink 2s infinite;
            font-weight: 600;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }

            .header-controls {
                width: 100%;
                justify-content: center;
            }

            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }

            .login-card {
                padding: 32px 24px;
            }

            .login-card h1 {
                font-size: 1.875rem;
            }

            .card-header, .card-body {
                padding: 16px;
            }

            .btn {
                padding: 8px 16px;
                font-size: 0.875rem;
            }

            .table-responsive {
                font-size: 0.8125rem;
            }

            .modal-content {
                padding: 24px 16px;
                margin: 20px;
            }

            .footer-links {
                flex-direction: column;
                gap: 12px;
            }
        }

        @media (max-width: 576px) {
            .theme-toggle span {
                display: none;
            }

            .nav-links a span {
                display: none;
            }

            .nav-links a {
                padding: 8px 12px;
            }

            .google-btn span {
                font-size: 0.875rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            .container {
                padding: 16px;
            }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Grid system */
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: -8px;
        }

        .col {
            flex: 1;
            padding: 8px;
        }

        .col-12 {
            flex: 0 0 100%;
            max-width: 100%;
            padding: 8px;
        }

        .g-3 {
            gap: 12px;
        }

        /* Table responsive fix */
        @media (max-width: 768px) {
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table {
                min-width: 600px;
            }

            .d-flex {
                flex-wrap: wrap;
            }
        }

        /* Budget alerts */
        #budgetAlerts {
            min-height: 22px;
            margin-top: 12px;
        }

        .text-danger {
            color: var(--danger) !important;
        }

        .text-warning {
            color: var(--warning) !important;
        }

        .text-success {
            color: var(--success) !important;
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        .text-center {
            text-align: center;
        }

        .d-flex {
            display: flex;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .align-items-center {
            align-items: center;
        }

        .w-100 {
            width: 100%;
        }

        .mt-3 {
            margin-top: 12px;
        }

        .mb-3 {
            margin-bottom: 12px;
        }

        .me-1 {
            margin-right: 4px;
        }
    </style>
</head>
<body data-theme="dark">

<!-- Background Animation -->
<div class="background-animation">
    <lottie-player
        src="https://lottie.host/fef0dd87-b7ca-430b-b7ff-f306c934d368/WKpgmIC1iO.lottie"
        background="transparent"
        speed="1"
        loop
        autoplay>
    </lottie-player>
</div>
<div class="gradient-overlay"></div>

<!-- ========== LOGIN VIEW ========== -->
<div id="loginView" class="login-wrapper">
    <div class="login-card">
        <h1>E-TRAX</h1>
        <p>Track expenses smarter. Sign in with Google to continue.</p>

        <button id="googleLoginBtn" class="google-btn" aria-label="Login with Google">
            <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google">
            <span>Sign in with Google</span>
        </button>

        <div class="note">We only use Google to authenticate you ‚Äî no payment info required.</div>
        <div class="developer">
            <small>Developed by <strong>ALPHA DEVELOPERS</strong></small>
        </div>
    </div>
</div>

<!-- ========== HEADER ========== -->
<header id="mainHeader" class="main-header" style="display: none;">
    <div class="header-content">
        <div class="brand-section">
            <h1>E-TRAX</h1>
            <div class="typing" id="typingHeader"></div>
        </div>
        
        <div class="header-controls">
            <div id="userNameDisplay"></div>
            
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-palette"></i>
                <span>Theme</span>
            </button>
            
            <nav class="nav-links">
                <a href="https://whatsapp.com/channel/0029Va5gnd0CcW4xKICHcb0k" target="_blank" rel="noopener">
                    <i class="fas fa-headset"></i>
                    <span>Support</span>
                </a>
                <a href="about.html">
                    <i class="fas fa-info-circle"></i>
                    <span>About</span>
                </a>
                <a href="#" id="historyLink">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </a>
                <button id="googleLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </nav>
        </div>
    </div>
</header>

<!-- ========== MAIN CONTAINER ========== -->
<div class="container">
    <!-- Budget Card -->
    <div id="budgetCard" class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h5 style="margin:0;color:var(--warning);">Budget Limit</h5>
                    <small class="text-muted">Set a monthly/total budget for your expenses</small>
                </div>
                <div>
                    <button id="resetBudgetBtn" class="btn btn-outline-danger btn-sm">Reset Budget</button>
                </div>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-12 col-md-5">
                    <input type="number" id="budgetInput" class="form-control" placeholder="Enter budget amount (e.g. 5000)">
                </div>
                <div class="col-12 col-md-3">
                    <button id="saveBudgetBtn" class="btn btn-primary w-100">Save Budget</button>
                </div>
                <div class="col-12 col-md-4 text-center text-md-end">
                    <div id="budgetStatusText" style="font-weight:600;">No budget set</div>
                </div>
            </div>

            <div id="budgetBar" class="mb-2">
                <div id="budgetProgress" class="progress" style="width:100%">
                    <div id="budgetProgressBar" class="progress-bar" role="progressbar" style="width:0%"></div>
                </div>
            </div>

            <div id="budgetAlerts"></div>
        </div>
    </div>

    <!-- Expense Form -->
    <div id="expenseFormContainer" style="display:none;">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Add New Expense</h5>
            </div>
            <div class="card-body">
                <form id="expenseForm" class="row g-3">
                    <input type="hidden" id="editId">
                    <div class="col-12 col-md-6">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" id="name" class="form-control" required>
                    </div>
                    <div class="col-12 col-md-6">
                        <label for="amount" class="form-label">Amount</label>
                        <input type="number" id="amount" class="form-control" required>
                    </div>
                    <div class="col-12 col-md-6">
                        <label for="type" class="form-label">Type</label>
                        <select id="type" class="form-select" required>
                            <option value="">Choose one...</option>
                            <option value="Card">Card</option>
                            <option value="Cash">Cash</option>
                            <option value="Gpay/Paytm">Gpay/Paytm</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-6">
                        <label for="description" class="form-label">Description</label>
                        <input type="text" id="description" class="form-control" required>
                    </div>
                    <div class="col-12 col-md-6">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" id="date" class="form-control" required>
                    </div>
                    <div class="col-12 d-flex justify-content-between mt-3">
                        <button type="reset" class="btn btn-danger">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i> Confirm
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Table Container -->
    <div id="tableContainer" class="table-responsive"></div>

    <!-- Analytics -->
    <div id="analyticsContainer" style="display:none;">
        <div class="table-container">
            <h4 class="text-center" style="color:var(--primary);">üìä Expense Analytics</h4>
            <div class="row">
                <div class="col-12 col-md-6">
                    <div class="chart-container">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                    <div id="analyticsBadge" class="text-center mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== MODALS ========== -->
<!-- History Modal -->
<div id="historyModal" class="modal-overlay">
    <div class="modal-content">
        <h2>üìù Edit History</h2>
        <div id="historyContent">
            <p>Loading history...</p>
        </div>
        <div class="text-center mt-3">
            <button id="closeHistory" class="btn btn-primary">Close</button>
        </div>
    </div>
</div>

<!-- ========== MESSAGE BOX ========== -->
<div id="msgBox"></div>

<!-- ========== FOOTER ========== -->
<footer>
    <div style="display:flex; flex-direction:column; align-items:center; gap:12px;">
        <div class="footer-links">
            <a href="terms-conditions.html">Terms & Conditions</a>
            <a href="privacy-policy.html">Privacy Policy</a>
        </div>
        
        <p style="margin:0;">
            Email: <a href="mailto:alphaprime.co.in@gmail.com">alphaprime.co.in@gmail.com</a>
        </p>
        
        <p style="margin:0;">&copy; 2025 <span class="blinking-name">E-TRAX</span>. All rights reserved.</p>
    </div>
</footer>

<script>
// All JavaScript code remains exactly the same as in your original index.html
// Only the CSS has been updated for professional design

// BASE URL
const BASE_URL = window.location.hostname.includes("localhost")
  ? "http://localhost:3000"
  : "https://sandy-backend2-0.onrender.com";

// Firebase will be initialized after fetching config from backend
let auth = null;
let currentUserUid = null;
let currentUserName = null;

// Theme Management
const themes = ['dark', 'light', 'professional'];
let currentThemeIndex = 0;

function initTheme() {
  const savedTheme = localStorage.getItem('theme') || 'dark';
  currentThemeIndex = themes.indexOf(savedTheme);
  applyTheme(savedTheme);
}

function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('theme', theme);
}

function cycleTheme() {
  currentThemeIndex = (currentThemeIndex + 1) % themes.length;
  applyTheme(themes[currentThemeIndex]);
}

// Initialize Firebase securely
async function initializeFirebase() {
  try { 
    const response = await fetch(`${BASE_URL}/firebase-config`);
    const firebaseConfig = await response.json();
    
    if (!firebaseConfig.apiKey) {
      throw new Error('Firebase config not available');
    }
    
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    console.log('Firebase initialized securely');
    
    // Now initialize auth state listener
    setupAuthListener();
    
  } catch (error) {
    console.error('Failed to initialize Firebase:', error);
    showMessage('‚ùå Failed to initialize app. Please refresh.', 5000);
  }
}

// Setup auth state listener after Firebase is initialized
function setupAuthListener() {
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUserUid = user.uid;
      currentUserName = user.displayName || "User";
      toggleLoginState(true);
      loadData();
      userNameDisplay.textContent = currentUserName;
      fetchBudget();
    } else {
      currentUserUid = null;
      currentUserName = null;
      toggleLoginState(false);
      tableContainer.innerHTML = "<p class='text-muted'>Login to view your expenses</p>";
      analyticsContainer.style.display = "none";
      userNameDisplay.textContent = "";
      clearBudgetUI();
    }
  });
}

// Elements
const loginBtn = document.getElementById("googleLoginBtn");
const logoutBtn = document.getElementById("googleLogoutBtn");
const loginView = document.getElementById("loginView");
const mainHeader = document.getElementById("mainHeader");
const expenseFormContainer = document.getElementById("expenseFormContainer");
const tableContainer = document.getElementById("tableContainer");
const msgBox = document.getElementById("msgBox");
const userNameDisplay = document.getElementById("userNameDisplay");
const analyticsContainer = document.getElementById("analyticsContainer");
const themeToggle = document.getElementById("themeToggle");
const historyLink = document.getElementById("historyLink");
const historyModal = document.getElementById("historyModal");
const closeHistory = document.getElementById("closeHistory");
const historyContent = document.getElementById("historyContent");

// Budget elements
const budgetCard = document.getElementById("budgetCard");
const budgetInput = document.getElementById("budgetInput");
const saveBudgetBtn = document.getElementById("saveBudgetBtn");
const resetBudgetBtn = document.getElementById("resetBudgetBtn");
const budgetProgressBar = document.getElementById("budgetProgressBar");
const budgetStatusText = document.getElementById("budgetStatusText");
const budgetAlerts = document.getElementById("budgetAlerts");
const analyticsBadge = document.getElementById("analyticsBadge");

let currentBudgetAmount = 0;

// About modal
const aboutLink = document.getElementById("aboutLink");
const aboutModal = document.getElementById("aboutModal");
const closeAbout = document.getElementById("closeAbout");

// Event Listeners
aboutLink && aboutLink.addEventListener("click", e => { e.preventDefault(); aboutModal.style.display = "block"; });
closeAbout && closeAbout.addEventListener("click", () => { aboutModal.style.display = "none"; });
historyLink && historyLink.addEventListener("click", e => { e.preventDefault(); showHistory(); });
closeHistory && closeHistory.addEventListener("click", () => { historyModal.style.display = "none"; });
themeToggle && themeToggle.addEventListener("click", cycleTheme);

window.addEventListener("click", e => { 
  if(e.target == aboutModal) aboutModal.style.display="none";
  if(e.target == historyModal) historyModal.style.display="none";
});

// Initialize theme and Firebase
initTheme();
initializeFirebase();

// Message function
function showMessage(msg, duration=2000) {
  msgBox.innerText = msg;
  msgBox.style.display = "block";
  setTimeout(()=> msgBox.style.display="none", duration);
}

// Toggle login state
function toggleLoginState(isLoggedIn) {
  loginView.style.display = isLoggedIn ? "none" : "flex";
  mainHeader.style.display = isLoggedIn ? "block" : "none";
  expenseFormContainer.style.display = isLoggedIn ? "block" : "none";
  budgetCard.style.display = isLoggedIn ? "block" : "none";
}

// Login button
loginBtn.addEventListener("click", async () => {
  if (!auth) {
    showMessage(" Please wait...", 2000);
    return;
  }
  
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    const result = await auth.signInWithPopup(provider);
    currentUserUid = result.user.uid;
    currentUserName = result.user.displayName || "User";
    toggleLoginState(true);
    loadData();
    userNameDisplay.textContent = currentUserName;
    showMessage("‚úÖ Logged in successfully",2000);
    fetchBudget();
  } catch(err){ 
    console.error(err); 
    showMessage("‚ùå Login failed",2000); 
  }
});

// Logout button
logoutBtn && logoutBtn.addEventListener("click", async () => {
  if (!auth) return;
  
  try {
    await auth.signOut();
    currentUserUid = null;
    currentUserName = null;
    toggleLoginState(false);
    tableContainer.innerHTML = "<p class='text-muted'>Login to view your expenses</p>";
    analyticsContainer.style.display="none";
    userNameDisplay.textContent = "";
    clearBudgetUI();
    showMessage("‚úÖ Logged out successfully",2000);
  } catch(err){ 
    console.error(err); 
    showMessage("‚ùå Logout failed",2000); 
  }
});

// Typing animation
const headerText = "Track Your Expenses Smartly!";
const typingHeader = document.getElementById("typingHeader");
let headerIndex = 0;
function typeWriterHeader() {
  if(headerIndex < headerText.length){
    typingHeader.innerHTML += headerText.charAt(headerIndex);
    headerIndex++;
    setTimeout(typeWriterHeader,100);
  } else {
    setTimeout(()=>{ typingHeader.innerHTML=""; headerIndex=0; typeWriterHeader(); },2000);
  }
}
typeWriterHeader();

// Expense form handling
const form = document.getElementById("expenseForm");
const editId = document.getElementById("editId");
form && form.addEventListener("submit", async e=>{
  e.preventDefault();
  if(!currentUserUid) return;
  const data = {
    uid: currentUserUid,
    name: document.getElementById("name").value.trim(),
    amount: document.getElementById("amount").value.trim(),
    type: document.getElementById("type").value,
    description: document.getElementById("description").value.trim(),
    date: document.getElementById("date").value
  };
  try {
    const url = editId.value ? `${BASE_URL}/update/${editId.value}` : `${BASE_URL}/submit`;
    const method = editId.value ? "PUT" : "POST";
    // Add editor name when updating
    if (editId.value) {
      data.editorName = currentUserName;
    }
    const res = await fetch(url,{ method, headers:{ "Content-Type":"application/json" }, body:JSON.stringify(data)});
    const result = await res.json();
    showMessage(result.message);
    editId.value="";
    form.reset();
    await loadData();
    await fetchBudget();
  } catch(err){ console.error(err); showMessage("‚ùå Failed to submit/edit expense",2500);}
});

// Budget functions
async function saveBudgetToServer(amount){
  if(!currentUserUid) return;
  try {
    const res = await fetch(`${BASE_URL}/setBudget`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ uid: currentUserUid, amount: parseFloat(amount) || 0 })
    });
    const r = await res.json();
    if(res.ok) showMessage(r.message || "Budget saved");
    else showMessage(r.message || "Failed to save budget");
    await fetchBudget();
  } catch(err){ console.error(err); showMessage("‚ùå Failed to save budget",2000); }
}

async function fetchBudget(){
  if(!currentUserUid) return clearBudgetUI();
  try {
    const res = await fetch(`${BASE_URL}/getBudget?uid=${currentUserUid}`);
    if(!res.ok) return clearBudgetUI();
    const r = await res.json();
    if(!r || typeof r.amount === "undefined" || r.amount === 0){
      currentBudgetAmount = 0;
      clearBudgetUI();
      return;
    }
    currentBudgetAmount = parseFloat(r.amount) || 0;
    const expensesRes = await fetch(`${BASE_URL}/users?uid=${currentUserUid}`);
    const arr = await expensesRes.json();
    let totalAmount = 0;
    if(Array.isArray(arr)) arr.forEach(x=> totalAmount += parseFloat(x.amount)||0);
    updateBudgetUI(currentBudgetAmount, totalAmount);
    budgetInput && (budgetInput.value = currentBudgetAmount);
  } catch(err){ console.error(err); clearBudgetUI(); }
}

function clearBudgetUI(){
  if(budgetInput) budgetInput.value = "";
  if(budgetProgressBar) budgetProgressBar.style.width = "0%";
  if(budgetProgressBar) budgetProgressBar.className = "progress-bar";
  if(budgetStatusText) budgetStatusText.innerText = "No budget set";
  if(budgetAlerts) budgetAlerts.innerHTML = "";
  currentBudgetAmount = 0;
  if(analyticsBadge) analyticsBadge.innerText = "";
}

function updateBudgetUI(budgetAmount, totalSpent){
  if(!budgetAmount || budgetAmount <= 0){
    clearBudgetUI();
    return;
  }
  const pct = (totalSpent / budgetAmount) * 100;
  const pctClamped = Math.min(Math.round(pct), 999);
  const widthPct = Math.min(pctClamped, 100);
  budgetProgressBar.style.width = widthPct + "%";
  budgetProgressBar.innerText = `${pctClamped}%`;
  budgetProgressBar.className = "progress-bar";
  if(pct >= 100){
    budgetProgressBar.classList.add("bg-danger");
  } else if(pct >= 80){
    budgetProgressBar.classList.add("bg-warning");
  } else {
    budgetProgressBar.classList.add("bg-success");
  }
  budgetStatusText.innerText = `Budget: ‚Çπ${budgetAmount.toFixed(2)}  ‚Äî  Spent: ‚Çπ${totalSpent.toFixed(2)}`;
  budgetAlerts.innerHTML = "";
  analyticsBadge.innerText = "";
  if(pct >= 100){
    const over = (totalSpent - budgetAmount);
    budgetAlerts.innerHTML = `<div class="text-danger" style="font-weight:700;">üö® Budget exceeded! You spent ‚Çπ${over.toFixed(2)} over the limit.</div>`;
    analyticsBadge.innerHTML = `<span class="badge badge-danger">üö® Over budget: ‚Çπ${over.toFixed(2)}</span>`;
  } else if(pct >= 80){
    budgetAlerts.innerHTML = `<div class="text-warning" style="font-weight:700;">‚ö†Ô∏è You're at ${Math.round(pct)}% of your budget. Be careful!</div>`;
    analyticsBadge.innerHTML = `<span class="badge badge-warning">‚ö†Ô∏è Usage: ${Math.round(pct)}% of budget</span>`;
  } else {
    analyticsBadge.innerHTML = `<span class="badge badge-success">‚úÖ Usage: ${Math.round(pct)}% of budget</span>`;
  }
}

// Save/Reset event listeners
saveBudgetBtn && saveBudgetBtn.addEventListener("click", async () => {
  const val = parseFloat(budgetInput.value);
  if(!val || val <= 0){ showMessage("Enter valid budget amount"); return; }
  await saveBudgetToServer(val);
});
resetBudgetBtn && resetBudgetBtn.addEventListener("click", async () => {
  if(!currentUserUid) return;
  if(!confirm("Reset/delete your budget?")) return;
  try {
    const res = await fetch(`${BASE_URL}/setBudget`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ uid: currentUserUid, amount: 0, reset: true })
    });
    const r = await res.json();
    if(res.ok) showMessage(r.message || "Budget reset");
    else showMessage(r.message || "Reset failed");
    clearBudgetUI();
  } catch(err){ console.error(err); showMessage("‚ùå Reset failed",2000); }
});

// Load data and render table - MOBILE FRIENDLY VERSION
async function loadData(){
  if(!currentUserUid) return;
  try{
    const res = await fetch(`${BASE_URL}/users?uid=${currentUserUid}`);
    if(!res.ok) throw new Error("Failed to fetch users");
    const users = await res.json();
    if(!Array.isArray(users) || users.length===0){
      tableContainer.innerHTML = "<p class='text-muted'>No expenses yet. Add your first expense above!</p>";
      analyticsContainer.style.display="none";
      const bRes = await fetch(`${BASE_URL}/getBudget?uid=${currentUserUid}`);
      if(bRes.ok){
        const b = await bRes.json();
        if(b && b.amount) updateBudgetUI(parseFloat(b.amount), 0);
      }
      return;
    }

    let totalAmount = 0;
    
    // Mobile-friendly table design
    if (window.innerWidth < 768) {
      // MOBILE VIEW - Card layout
      let mobileHtml = `<div class="table-container">
        <h5 class="text-center mb-3" style="color:var(--primary);">Your Expenses</h5>
        <div class="row g-3">`;
      
      users.forEach((u,i)=>{
        totalAmount += parseFloat(u.amount) || 0;
        
        mobileHtml += `
          <div class="col-12">
            <div class="card expense-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="card-title mb-0" style="color:var(--primary);">${u.name}</h6>
                  <span class="badge">${u.type}</span>
                </div>
                
                <div class="expense-details">
                  <div class="row small text-muted mb-2">
                    <div class="col-6">
                      <i class="fas fa-rupee-sign"></i> <strong>${parseFloat(u.amount).toFixed(2)}</strong>
                    </div>
                    <div class="col-6 text-end">
                      <i class="fas fa-calendar"></i> ${u.date}
                    </div>
                  </div>
                  
                  <p class="small mb-3" style="color:var(--text-light);">
                    <i class="fas fa-file-alt"></i> ${u.description}
                  </p>
                  
                  <div class="d-flex justify-content-between">
                    <button class="btn btn-warning btn-sm" onclick="editExpense('${u._id}')">
                      <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-info btn-sm" onclick="viewHistory('${u._id}')">
                      <i class="fas fa-history"></i> 
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteExpense('${u._id}','${u.name}')">
                      <i class="fas fa-trash"></i> 
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      });

      mobileHtml += `
        </div>
        
        <!-- Total Summary -->
        <div class="card mt-3" style="background:var(--primary); color:white;">
          <div class="card-body text-center">
            <h6 class="mb-0">Total Expenses: ‚Çπ${totalAmount.toFixed(2)}</h6>
          </div>
        </div>
      </div>`;
      
      tableContainer.innerHTML = mobileHtml;
      
    } else {
      // DESKTOP VIEW - Table layout
      let desktopHtml = `<div class="table-container">
        <div class="table-responsive">
          <table class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Amount</th>
                <th>Type</th>
                <th>Description</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>`;

      users.forEach((u,i)=>{
        totalAmount += parseFloat(u.amount) || 0;
        const actionBtn = `
          <div class="btn-group">
            <button class="btn btn-warning btn-sm me-1" onclick="editExpense('${u._id}')" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-info btn-sm me-1" onclick="viewHistory('${u._id}')" title="History">
              <i class="fas fa-history"></i>
            </button>
            <button class="btn btn-danger btn-sm" onclick="deleteExpense('${u._id}','${u.name}')" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        desktopHtml += `
          <tr>
            <td>${i+1}</td>
            <td>${u.name}</td>
            <td>‚Çπ${parseFloat(u.amount).toFixed(2)}</td>
            <td><span class="badge">${u.type}</span></td>
            <td>${u.description}</td>
            <td>${u.date}</td>
            <td>${actionBtn}</td>
          </tr>
        `;
      });

      desktopHtml += `
            </tbody>
          </table>
        </div>
        
        <!-- Total Row -->
        <div class="mt-3 p-3 rounded" style="background:var(--primary); color:white;">
          <div class="row">
            <div class="col-6 text-end">
              <strong>Total Expenses:</strong>
            </div>
            <div class="col-6">
              <strong>‚Çπ${totalAmount.toFixed(2)}</strong>
            </div>
          </div>
        </div>
      </div>`;
      
      tableContainer.innerHTML = desktopHtml;
    }

    analyticsContainer.style.display="block";
    renderCharts(users);

    const bRes = await fetch(`${BASE_URL}/getBudget?uid=${currentUserUid}`);
    if(bRes.ok){
      const b = await bRes.json();
      if(b && b.amount && parseFloat(b.amount) > 0){
        updateBudgetUI(parseFloat(b.amount), totalAmount);
      } else clearBudgetUI();
    }
  } catch(err){ 
    console.error(err); 
    tableContainer.innerHTML=`
      <div class="alert alert-danger text-center">
        <i class="fas fa-exclamation-triangle"></i> Failed to load expenses. Please try again.
      </div>
    `; 
  }
}

// Edit and Delete handlers
window.editExpense = async function(id){
  try{
    const res = await fetch(`${BASE_URL}/user/${id}`);
    if(!res.ok) throw new Error("Failed to fetch user");
    const user = await res.json();
    document.getElementById("name").value=user.name;
    document.getElementById("amount").value=user.amount;
    document.getElementById("type").value=user.type;
    document.getElementById("description").value=user.description;
    document.getElementById("date").value=user.date;
    editId.value=id;
    showMessage("‚úè Edit mode enabled - Make your changes and click Confirm",2000);
  } catch(err){ console.error(err); showMessage("‚ùå Failed to fetch expense for editing.",2500);}
}

window.deleteExpense = async function(id, name){
  if(!confirm(`Are you sure you want to delete expense "${name}"? This action cannot be undone.`)) return;
  try{
    const res = await fetch(`${BASE_URL}/delete/${id}`, { method: "DELETE" });
    const r = await res.json();
    if(res.ok){
      showMessage("‚úÖ Expense deleted successfully");
      await loadData();
      await fetchBudget();
    } else {
      showMessage(r.message || "Delete failed",2000);
    }
  } catch(err){ console.error(err); showMessage("‚ùå Failed to delete expense",2000); }
}

// History functions
window.viewHistory = async function(expenseId) {
  try {
    const res = await fetch(`${BASE_URL}/user/${expenseId}`);
    if(!res.ok) throw new Error("Failed to fetch expense");
    const expense = await res.json();
    
    let historyHtml = `
      <h4>Edit History for: <strong>${expense.name}</strong></h4>
      <p><strong>Created:</strong> ${new Date(expense.createdAt).toLocaleString()} by You</p>
    `;
    
    if (expense.editHistory && expense.editHistory.length > 0) {
      historyHtml += `
        <table class="table">
          <thead>
            <tr>
              <th>Editor</th>
              <th>Date & Time</th>
              <th>Changes Made</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      expense.editHistory.forEach(edit => {
        const changes = [];
        if (edit.before.name !== edit.after.name) {
          changes.push(`Name: "${edit.before.name}" ‚Üí "${edit.after.name}"`);
        }
        if (edit.before.amount !== edit.after.amount) {
          changes.push(`Amount: ‚Çπ${edit.before.amount} ‚Üí ‚Çπ${edit.after.amount}`);
        }
        if (edit.before.type !== edit.after.type) {
          changes.push(`Type: ${edit.before.type} ‚Üí ${edit.after.type}`);
        }
        if (edit.before.description !== edit.after.description) {
          changes.push(`Description: "${edit.before.description}" ‚Üí "${edit.after.description}"`);
        }
        if (edit.before.date !== edit.after.date) {
          changes.push(`Date: ${edit.before.date} ‚Üí ${edit.after.date}`);
        }
        
        historyHtml += `
          <tr>
            <td><strong>${edit.editorName}</strong></td>
            <td>${new Date(edit.date).toLocaleString()}</td>
            <td>
              ${changes.map(change => `<div>${change}</div>`).join('')}
            </td>
          </tr>
        `;
      });
      
      historyHtml += `</tbody></table>`;
    } else {
      historyHtml += `<p class="text-muted">No edit history available for this expense.</p>`;
    }
    
    historyContent.innerHTML = historyHtml;
    historyModal.style.display = "block";
  } catch(err) {
    console.error(err);
    historyContent.innerHTML = "<p class='text-danger'>Failed to load history.</p>";
  }
}

async function showHistory() {
  try {
    const res = await fetch(`${BASE_URL}/users?uid=${currentUserUid}`);
    if(!res.ok) throw new Error("Failed to fetch expenses");
    const expenses = await res.json();
    
    let historyHtml = `<h4>Complete Edit History</h4>`;
    
    const expensesWithHistory = expenses.filter(exp => exp.editHistory && exp.editHistory.length > 0);
    
    if (expensesWithHistory.length === 0) {
      historyHtml += `<p class="text-muted">No edit history available yet.</p>`;
    } else {
      expensesWithHistory.forEach(expense => {
        historyHtml += `
          <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.05); border-radius: 8px;">
            <h5>${expense.name} - ‚Çπ${parseFloat(expense.amount).toFixed(2)}</h5>
            <p><small>Total edits: ${expense.editCount || 0}</small></p>
            <button class="btn btn-sm btn-info" onclick="viewHistory('${expense._id}')">
              View Detailed History
            </button>
          </div>
        `;
      });
    }
    
    historyContent.innerHTML = historyHtml;
    historyModal.style.display = "block";
  } catch(err) {
    console.error(err);
    historyContent.innerHTML = "<p class='text-danger'>Failed to load history.</p>";
  }
}

// Charts renderer
function renderCharts(users){
  const dates = {};
  const types = {};

  let totalAmount = 0;
  users.forEach(u=>{
    const date = u.date || "Unknown";
    const amount = parseFloat(u.amount) || 0;
    totalAmount += amount;
    dates[date] = (dates[date]||0)+amount;
    types[u.type] = (types[u.type]||0)+amount;
  });

  const overAmount = currentBudgetAmount && totalAmount > currentBudgetAmount ? (totalAmount - currentBudgetAmount) : 0;
  
  // Add over budget as separate category if exists
  if (overAmount > 0) {
    types['Over Budget'] = overAmount;
  }

  const lineCtx = document.getElementById('lineChart').getContext('2d');
  if(window.lineChartInstance) window.lineChartInstance.destroy();
  window.lineChartInstance = new Chart(lineCtx, {
    type: 'line',
    data: {
      labels: Object.keys(dates),
      datasets: [{
        label: 'Daily Expenses',
        data: Object.values(dates),
        borderColor: 'var(--primary)',
        backgroundColor: 'rgba(37, 99, 235, 0.2)',
        fill: true,
        tension: 0.3
      }]
    },
    options: { 
      responsive: true,
      maintainAspectRatio: false,
      scales: { 
        y: { 
          beginAtZero:true,
          ticks: { color: 'var(--text-light)' },
          grid: { color: 'var(--border)' }
        },
        x: {
          ticks: { color: 'var(--text-light)' },
          grid: { color: 'var(--border)' }
        }
      },
      plugins: {
        legend: {
          labels: { color: 'var(--text-light)' }
        }
      }
    }
  });

  const pieCtx = document.getElementById('pieChart').getContext('2d');
  if(window.pieChartInstance) window.pieChartInstance.destroy();

  const labels = Object.keys(types);
  const values = Object.values(types);

  // Color assignment for categories
  const categoryColors = {
    'Card': '#2563eb',      // Blue
    'Cash': '#f59e0b',      // Orange
    'Gpay/Paytm': '#10b981', // Green
    'Other': '#8b5cf6',     // Purple
    'Over Budget': '#ef4444' // Red
  };

  // Assign colors
  const bgColors = labels.map(label => {
    return categoryColors[label] || 
           `hsl(${Math.random() * 360}, 70%, 60%)`;
  });

  window.pieChartInstance = new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: bgColors,
        borderColor: 'var(--card-bg)',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: 'var(--text-light)',
            padding: 15,
            font: { size: 11 }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = Math.round((value / total) * 100);
              return `${label}: ‚Çπ${value.toFixed(2)} (${percentage}%)`;
            }
          }
        }
      }
    }
  });

  // Update analytics badge
  if(overAmount > 0){
    analyticsBadge.innerHTML = `<span class="badge" style="background:var(--danger);">üö® Over budget: ‚Çπ${overAmount.toFixed(2)}</span>`;
  } else if(currentBudgetAmount > 0) {
    const usagePercent = Math.round((totalAmount / currentBudgetAmount) * 100);
    analyticsBadge.innerHTML = `<span class="badge" style="background:var(--success);">‚úÖ Usage: ${usagePercent}% of budget</span>`;
  } else {
    analyticsBadge.innerHTML = `<span class="badge">üìä Total: ‚Çπ${totalAmount.toFixed(2)}</span>`;
  }
}

// Start the typing animation
typeWriterHeader();

// Service Worker Registration
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/sw.js")
      .then(() => console.log("Service Worker registered"))
      .catch(err => console.error("SW failed", err));
  });
}
</script>
</body>
</html>
