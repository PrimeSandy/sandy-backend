<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>E-Trax!</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- socket.io client will be loaded from server below -->
<style>
/* (Keep your existing CSS - unchanged for brevity) */
/* ... paste your existing CSS from previous file ... */
body { background-color:#0b0b0b; color:white; font-family:"Poppins",sans-serif; min-height:100vh; margin:0; }
/* (include all other CSS you already had) */
</style>
</head>
<body>
<!-- (Keep your entire existing HTML structure same) -->
<!-- Copy the HTML content you already have (login button, header, forms, tableContainer, analyticsContainer, about modal, footer) -->
<!-- For brevity here we assume entire DOM from your provided index.html remains unchanged -->
<!-- ... -->

<!-- Add socket.io client script (served by server) -->
<script src="/socket.io/socket.io.js"></script>

<script>
// BASE URL - keep as before
const BASE_URL = window.location.hostname.includes("localhost")
  ? "http://localhost:3000"
  : "https://sandy-backend2-0.onrender.com";

// Firebase Config (same as yours)
const firebaseConfig = {
  apiKey: "AIzaSyDgeOmsWD36spVcXw9QVSbUs4nmx-iXGak",
  authDomain: "ptspro-31997.firebaseapp.com",
  projectId: "ptspro-31997",
  storageBucket: "ptspro-31997.appspot.com",
  messagingSenderId: "191965542623",
  appId: "1:191965542623:web:b461ceedfc3a773267516a",
  measurementId: "G-6LNC29KRQF"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
let currentUserUid = null;
let currentUserName = null;

// socket.io client connect
// Note: If BASE_URL is remote, ensure socket connects to same origin or pass the URL
const socket = io(window.location.origin); // connects to same host/port serving page

socket.on("connect", () => {
  console.log("Socket connected:", socket.id);
  if(currentUserUid) socket.emit("join", currentUserUid);
});

socket.on("expenses-changed", (payload) => {
  // payload: { action: "created"|"updated", id, uid }
  if(!currentUserUid) return;
  if(payload && payload.uid === currentUserUid){
    // reload data for current user (real-time)
    console.log("Realtime: expenses changed ->", payload);
    loadData();
    fetchBudget();
  }
});

socket.on("budget-changed", (payload) => {
  if(!currentUserUid) return;
  if(payload && payload.uid === currentUserUid){
    console.log("Realtime: budget changed ->", payload);
    fetchBudget();
  }
});

/* ----- Keep your existing element references and functions ----- */
/* Copy all DOM element queries, showMessage, toggleLoginState, typing header, etc. */
/* For brevity, paste your full existing JS here ‚Äî but we will highlight necessary changes below. */

/* ----------------- REQUIRED CHANGES (frontend) -----------------
  1) When editing (PUT /update/:id), include editorName in body (current user's displayName).
  2) When socket connects and after login, emit join with uid so server can push to that room.
  3) Display edit metadata (createdAt, updatedAt, editCount, editHistory) in table/cards.
---------------------------------------------------------------- */

/* (Now paste your existing JS with these specific updates:) */

// Elements (copy from your original)
const loginBtn = document.getElementById("googleLoginBtn");
const logoutBtn = document.getElementById("googleLogoutBtn");
const loginContainer = document.getElementById("loginContainer");
const expenseFormContainer = document.getElementById("expenseFormContainer");
const tableContainer = document.getElementById("tableContainer");
const msgBox = document.getElementById("msgBox");
const userNameDisplay = document.getElementById("userNameDisplay");
const analyticsContainer = document.getElementById("analyticsContainer");
const budgetCard = document.getElementById("budgetCard");
const budgetInput = document.getElementById("budgetInput");
const saveBudgetBtn = document.getElementById("saveBudgetBtn");
const resetBudgetBtn = document.getElementById("resetBudgetBtn");
const budgetProgressBar = document.getElementById("budgetProgressBar");
const budgetStatusText = document.getElementById("budgetStatusText");
const budgetAlerts = document.getElementById("budgetAlerts");
const analyticsBadge = document.getElementById("analyticsBadge");
let currentBudgetAmount = 0;
const aboutLink = document.getElementById("aboutLink");
const aboutModal = document.getElementById("aboutModal");
const closeAbout = document.getElementById("closeAbout");
aboutLink.addEventListener("click", e => { e.preventDefault(); aboutModal.style.display = "block"; });
closeAbout.addEventListener("click", () => { aboutModal.style.display = "none"; });
window.addEventListener("click", e => { if(e.target == aboutModal) aboutModal.style.display="none"; });

function showMessage(msg, duration=2000) {
  msgBox.innerText = msg;
  msgBox.style.display = "block";
  setTimeout(()=> msgBox.style.display="none", duration);
}

function toggleLoginState(isLoggedIn) {
  loginContainer.style.display = isLoggedIn ? "none" : "block";
  logoutBtn.style.display = isLoggedIn ? "inline-block" : "none";
  expenseFormContainer.style.display = isLoggedIn ? "block" : "none";
  document.querySelector("header").style.display = isLoggedIn ? "block" : "none";
  budgetCard.style.display = isLoggedIn ? "block" : "none";
  analyticsContainer.style.display = isLoggedIn ? analyticsContainer.style.display : "none";
}

// Firebase Auth
auth.onAuthStateChanged(user=>{
  if(user){
    currentUserUid=user.uid;
    currentUserName = user.displayName || "User";
    toggleLoginState(true);
    // join socket room for this uid
    if(socket && socket.connected) socket.emit("join", currentUserUid);
    loadData();
    userNameDisplay.textContent = user.displayName || "User";
    fetchBudget();
  } else {
    currentUserUid=null;
    currentUserName=null;
    toggleLoginState(false);
    tableContainer.innerHTML = "<p class='text-muted'>Login to view your expenses</p>";
    analyticsContainer.style.display="none";
    userNameDisplay.textContent = "";
    clearBudgetUI();
  }
});

loginBtn.addEventListener("click", async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    const result = await auth.signInWithPopup(provider);
    currentUserUid = result.user.uid;
    currentUserName = result.user.displayName || "User";
    toggleLoginState(true);
    // join user's socket room
    if(socket && socket.connected) socket.emit("join", currentUserUid);
    loadData();
    userNameDisplay.textContent = result.user.displayName || "User";
    showMessage("‚úÖ Logged in successfully",2000);
    fetchBudget();
  } catch(err){ console.error(err); showMessage("‚ùå Login failed",2000); }
});

logoutBtn.addEventListener("click", async () => {
  try {
    await auth.signOut();
    currentUserUid = null;
    currentUserName = null;
    toggleLoginState(false);
    tableContainer.innerHTML = "<p class='text-muted'>Login to view your expenses</p>";
    analyticsContainer.style.display="none";
    userNameDisplay.textContent = "";
    clearBudgetUI();
    showMessage("‚úÖ Logged out successfully",2000);
  } catch(err){ console.error(err); showMessage("‚ùå Logout failed",2000); }
});

// typing animation (same as yours)
const headerText = "Drop Your Expenses !";
const typingHeader = document.getElementById("typingHeader");
let headerIndex = 0;
function typeWriterHeader() {
  if(!typingHeader) return;
  if(headerIndex < headerText.length){
    typingHeader.innerHTML += headerText.charAt(headerIndex);
    headerIndex++;
    setTimeout(typeWriterHeader,100);
  } else {
    setTimeout(()=>{ typingHeader.innerHTML=""; headerIndex=0; typeWriterHeader(); },2000);
  }
}
typeWriterHeader();

// FORM submit (modified: include editorName for updates)
const form = document.getElementById("expenseForm");
const editId = document.getElementById("editId");

form.addEventListener("submit", async e=>{
  e.preventDefault();
  if(!currentUserUid) return showMessage("Login required");
  const data = {
    uid: currentUserUid,
    name: document.getElementById("name").value.trim(),
    amount: document.getElementById("amount").value.trim(),
    type: document.getElementById("type").value,
    description: document.getElementById("description").value.trim(),
    date: document.getElementById("date").value
  };
  try {
    if(editId.value){
      // include editorName for edit history
      data.editorName = currentUserName || null;
    }
    const url = editId.value ? `${BASE_URL}/update/${editId.value}` : `${BASE_URL}/submit`;
    const method = editId.value ? "PUT" : "POST";
    const res = await fetch(url,{ method, headers:{ "Content-Type":"application/json" }, body:JSON.stringify(data)});
    const result = await res.json();
    showMessage(result.message || "Done");
    editId.value="";
    form.reset();
    // loadData() will also be triggered by socket event, but do a local refresh to be snappy
    await loadData();
    await fetchBudget();
  } catch(err){ console.error(err); showMessage("‚ùå Failed to submit/edit expense",2500);}
});

// Budget functions (unchanged except real-time handled on server side)
async function saveBudgetToServer(amount){
  if(!currentUserUid) return;
  try {
    const res = await fetch(`${BASE_URL}/setBudget`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ uid: currentUserUid, amount: parseFloat(amount) || 0 })
    });
    const r = await res.json();
    if(res.ok) showMessage(r.message || "Budget saved");
    else showMessage(r.message || "Failed to save budget");
    await fetchBudget();
  } catch(err){ console.error(err); showMessage("‚ùå Failed to save budget",2000); }
}

async function fetchBudget(){
  if(!currentUserUid) return clearBudgetUI();
  try {
    const res = await fetch(`${BASE_URL}/getBudget?uid=${currentUserUid}`);
    if(!res.ok) return clearBudgetUI();
    const r = await res.json();
    if(!r || typeof r.amount === "undefined" || r.amount === 0){
      currentBudgetAmount = 0;
      clearBudgetUI();
      return;
    }
    currentBudgetAmount = parseFloat(r.amount) || 0;
    const expensesRes = await fetch(`${BASE_URL}/users?uid=${currentUserUid}`);
    const arr = await expensesRes.json();
    let totalAmount = 0;
    if(Array.isArray(arr)) arr.forEach(x=> totalAmount += parseFloat(x.amount)||0);
    updateBudgetUI(currentBudgetAmount, totalAmount);
    budgetInput.value = currentBudgetAmount;
  } catch(err){ console.error(err); clearBudgetUI(); }
}

function clearBudgetUI(){
  budgetInput.value = "";
  if(budgetProgressBar) budgetProgressBar.style.width = "0%";
  if(budgetProgressBar) budgetProgressBar.className = "progress-bar";
  budgetStatusText.innerText = "No budget set";
  budgetAlerts.innerHTML = "";
  currentBudgetAmount = 0;
  analyticsBadge.innerText = "";
}

function updateBudgetUI(budgetAmount, totalSpent){
  if(!budgetAmount || budgetAmount <= 0){
    clearBudgetUI();
    return;
  }
  const pct = (totalSpent / budgetAmount) * 100;
  const pctClamped = Math.min(Math.round(pct), 999);
  const widthPct = Math.min(pctClamped, 100);
  budgetProgressBar.style.width = widthPct + "%";
  budgetProgressBar.innerText = `${pctClamped}%`;
  budgetProgressBar.className = "progress-bar";
  if(pct >= 100) budgetProgressBar.classList.add("bg-danger");
  else if(pct >= 80) budgetProgressBar.classList.add("bg-warning");
  else budgetProgressBar.classList.add("bg-success");
  budgetStatusText.innerText = `Budget: ‚Çπ${budgetAmount.toFixed(2)}  ‚Äî  Spent: ‚Çπ${totalSpent.toFixed(2)}`;
  budgetAlerts.innerHTML = "";
  analyticsBadge.innerText = "";
  if(pct >= 100){
    const over = (totalSpent - budgetAmount);
    budgetAlerts.innerHTML = `<div class="text-danger" style="font-weight:700;">üö® Budget exceeded! You spent ‚Çπ${over.toFixed(2)} over the limit.</div>`;
    analyticsBadge.innerHTML = `üö® Over budget: ‚Çπ${over.toFixed(2)} (shown as red slice in chart)`;
  } else if(pct >= 80){
    budgetAlerts.innerHTML = `<div class="text-warning" style="font-weight:700;">‚ö†Ô∏è You're at ${Math.round(pct)}% of your budget. Be careful!</div>`;
    analyticsBadge.innerHTML = `‚ö†Ô∏è Usage: ${Math.round(pct)}% of budget`;
  } else {
    analyticsBadge.innerHTML = `‚úÖ Usage: ${Math.round(pct)}% of budget`;
  }
}

saveBudgetBtn.addEventListener("click", async () => {
  const val = parseFloat(budgetInput.value);
  if(!val || val <= 0){ showMessage("Enter valid budget amount"); return; }
  await saveBudgetToServer(val);
});

resetBudgetBtn.addEventListener("click", async () => {
  if(!currentUserUid) return;
  if(!confirm("Reset/delete your budget?")) return;
  try {
    const res = await fetch(`${BASE_URL}/setBudget`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ uid: currentUserUid, amount: 0, reset: true })
    });
    const r = await res.json();
    if(res.ok) showMessage(r.message || "Budget reset");
    else showMessage(r.message || "Reset failed");
    clearBudgetUI();
  } catch(err){ console.error(err); showMessage("‚ùå Reset failed",2000); }
});

// Load data (updated to show edit metadata)
async function loadData(){
  if(!currentUserUid) return;
  try{
    const res = await fetch(`${BASE_URL}/users?uid=${currentUserUid}`);
    if(!res.ok) throw new Error("Failed to fetch users");
    const users = await res.json();
    if(!Array.isArray(users) || users.length===0){
      tableContainer.innerHTML = "<p class='text-muted'>No expenses yet.</p>";
      analyticsContainer.style.display="none";
      const bRes = await fetch(`${BASE_URL}/getBudget?uid=${currentUserUid}`);
      if(bRes.ok){
        const b = await bRes.json();
        if(b && b.amount) updateBudgetUI(parseFloat(b.amount), 0);
      }
      return;
    }

    // We'll render a table but also put an "info" collapsible row for each expense
    let html = `<table class="table table-striped table-bordered text-white">
      <thead><tr>
        <th>#</th><th>Name</th><th>Amount</th><th>Type</th><th>Description</th><th>Date</th><th>Info</th><th>Action</th>
      </tr></thead><tbody>`;

    let totalAmount = 0;
    users.forEach((u,i)=>{
      totalAmount += parseFloat(u.amount) || 0;
      const infoId = `info_${u._id}`;
      const createdAt = u.createdAt ? new Date(u.createdAt).toLocaleString() : "N/A";
      const updatedAt = u.updatedAt ? new Date(u.updatedAt).toLocaleString() : "N/A";
      const editCount = u.editCount || 0;
      // build a small history summary (limit last 5)
      let historyHtml = "<div style='max-height:140px; overflow:auto;'>";
      if(Array.isArray(u.editHistory) && u.editHistory.length>0){
        u.editHistory.slice().reverse().slice(0,10).forEach((h, idx)=>{
          const when = h.date ? new Date(h.date).toLocaleString() : "N/A";
          const who = h.editorName || h.editorUid || "Unknown";
          historyHtml += `<div style="border-bottom:1px solid rgba(255,255,255,0.06); padding:6px 0;">
            <small><b>${who}</b> ‚Äî ${when}</small>
            <div style="font-size:0.85rem; color:#ddd;">Before: ${h.before?.name || "-"} | ${h.before?.amount || "-"} | ${h.before?.type || "-"}</div>
            <div style="font-size:0.85rem; color:#bfbfbf;">After: ${h.after?.name || "-"} | ${h.after?.amount || "-"} | ${h.after?.type || "-"}</div>
          </div>`;
        });
      } else {
        historyHtml += "<div style='color:#bbb; padding:6px 0;'>No edits yet</div>";
      }
      historyHtml += "</div>";

      const actionBtn = `<button class="btn btn-warning btn-sm" onclick="editExpense('${u._id}')">Edit</button>`;
      const infoBtn = `<button class="btn btn-sm btn-info" onclick="toggleInfo('${infoId}')">View</button>`;

      html += `<tr>
        <td>${i+1}</td>
        <td>${escapeHtml(u.name)}</td>
        <td>${u.amount}</td>
        <td>${escapeHtml(u.type)}</td>
        <td>${escapeHtml(u.description)}</td>
        <td>${u.date}</td>
        <td>${infoBtn}</td>
        <td>${actionBtn}</td>
      </tr>
      <tr id="${infoId}" class="info-row" style="display:none; background:#111;">
        <td colspan="8" style="color:#ddd;">
          <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;">
            <div><b>Created:</b> ${createdAt}</div>
            <div><b>Last Updated:</b> ${updatedAt}</div>
            <div><b>Edited:</b> ${editCount} time(s)</div>
          </div>
          <hr style="border-color:rgba(255,255,255,0.05);" />
          <div>${historyHtml}</div>
        </td>
      </tr>
      `;
    });

    html += `
      <tr style="background:#00bcd4; color:#000; font-weight:700;">
        <td colspan="2" class="text-end">Total</td>
        <td colspan="6">${totalAmount.toFixed(2)}</td>
      </tr>
    `;
    html += "</tbody></table>";
    tableContainer.innerHTML=html;

    analyticsContainer.style.display="block";
    renderCharts(users);

    // Update budget UI with totals
    const bRes = await fetch(`${BASE_URL}/getBudget?uid=${currentUserUid}`);
    if(bRes.ok){
      const b = await bRes.json();
      if(b && b.amount && parseFloat(b.amount) > 0){
        updateBudgetUI(parseFloat(b.amount), totalAmount);
      } else {
        clearBudgetUI();
      }
    }
  } catch(err){ console.error(err); tableContainer.innerHTML="<p class='text-danger'>Failed to load expenses.</p>"; }
}

// helper toggle info row
function toggleInfo(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = (el.style.display === "none" || el.style.display === "") ? "table-row" : "none";
}

// Edit - fetch single expense and populate form (unchanged but when saving PUT includes editorName)
window.editExpense = async function(id){
  try{
    const res = await fetch(`${BASE_URL}/user/${id}`);
    if(!res.ok) throw new Error("Failed to fetch user");
    const user = await res.json();
    document.getElementById("name").value=user.name;
    document.getElementById("amount").value=user.amount;
    document.getElementById("type").value=user.type;
    document.getElementById("description").value=user.description;
    document.getElementById("date").value=user.date;
    editId.value=id;
    showMessage("‚úè Edit mode enabled",2000);
  } catch(err){ console.error(err); showMessage("‚ùå Failed to fetch expense for editing.",2500);}
}

// Chart rendering (same as before)
function renderCharts(users){
  const dates = {};
  const types = {};
  let totalAmount = 0;
  users.forEach(u=>{
    const date = u.date || "Unknown";
    const amount = parseFloat(u.amount) || 0;
    totalAmount += amount;
    dates[date] = (dates[date]||0)+amount;
    types[u.type] = (types[u.type]||0)+amount;
  });

  const overAmount = currentBudgetAmount && totalAmount > currentBudgetAmount ? (totalAmount - currentBudgetAmount) : 0;
  if(overAmount > 0){
    const label = `Over Budget (‚Çπ${overAmount.toFixed(2)})`;
    types[label] = overAmount;
  }

  const lineCtx = document.getElementById('lineChart').getContext('2d');
  if(window.lineChartInstance) window.lineChartInstance.destroy();
  window.lineChartInstance = new Chart(lineCtx, {
    type: 'line',
    data: {
      labels: Object.keys(dates),
      datasets: [{
        label: 'Total Expense',
        data: Object.values(dates),
        borderColor: '#00bcd4',
        backgroundColor: 'rgba(0,188,212,0.2)',
        fill: true,
        tension: 0.3
      }]
    },
    options: { scales: { y: { beginAtZero:true } } }
  });

  const pieCtx = document.getElementById('pieChart').getContext('2d');
  if(window.pieChartInstance) window.pieChartInstance.destroy();
  const labels = Object.keys(types);
  const values = Object.values(types);
  const baseColors = ['#00bcd4','#ff9800','#8bc34a','#e91e63','#9c27b0','#3f51b5','#009688'];
  const bgColors = labels.map(l => l.startsWith("Over Budget") ? '#ff3b30' : baseColors.shift() || '#607d8b');

  window.pieChartInstance = new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels,
      datasets: [{ data: values, backgroundColor: bgColors }]
    }
  });

  if(overAmount > 0){
    analyticsBadge.innerText = `üö® Over budget: ‚Çπ${overAmount.toFixed(2)} ‚Äî shown as red slice in chart.`;
  } else if(currentBudgetAmount > 0){
    analyticsBadge.innerText = `‚úÖ Within budget: Budget ‚Çπ${currentBudgetAmount.toFixed(2)}, Spent ‚Çπ${totalAmount.toFixed(2)}.`;
  } else {
    analyticsBadge.innerText = "";
  }
}

// simple escape helper for HTML injection safety
function escapeHtml(unsafe) {
  if(!unsafe && unsafe !== 0) return "";
  return String(unsafe)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

/* ------------------------------------------------------------------- */
/* That's it ‚Äî main realtime + edit-history integration done on frontend */
/* ------------------------------------------------------------------- */

</script>

<!-- footer (keep your existing footer) -->
</body>
</html>
