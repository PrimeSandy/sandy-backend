<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E-Trax Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f6fbff;
      --card:#ffffff;
      --muted:#6b7280;
      --brand:#0d6efd;
      --accent:#00bcd4;
    }
    *{box-sizing:border-box;font-family:'Poppins',sans-serif}
    body{background:var(--bg); margin:0; color:#0b1320; min-height:100vh;}
    .topbar{background:linear-gradient(90deg,#ffffff 0%, #f0f7ff 100%); border-bottom:1px solid rgba(13,110,253,0.06); padding:14px 18px; position:sticky; top:0; z-index:50}
    .brand { color:var(--brand); font-weight:700; font-size:1.25rem; }
    .sub { color:var(--muted); font-size:0.9rem; }

    .container-main{max-width:1100px;margin:18px auto;padding:16px;}
    .card-elev{background:var(--card); border-radius:12px; box-shadow:0 6px 18px rgba(12,35,70,0.06); padding:18px; margin-bottom:16px;}
    .grid-2{display:grid; grid-template-columns:1fr 360px; gap:16px;}
    @media (max-width:900px){ .grid-2{grid-template-columns:1fr; } .right-col{order:2} .left-col{order:1} }

    /* login */
    #loginContainer{display:flex; align-items:center; justify-content:center; min-height:60vh;}
    .btn-google{background:#fff; border:1px solid #e6e8f0; padding:10px 16px; border-radius:10px; display:inline-flex; gap:10px; align-items:center; font-weight:600; color:#111}
    .btn-google img{width:20px;height:20px}

    /* budget */
    .budget-head{display:flex; justify-content:space-between; align-items:center; gap:8px}
    .progress {height:16px; border-radius:10px; overflow:hidden; background: #eef6ff;}

    /* table */
    .table thead th{background:linear-gradient(90deg,var(--accent), #4aa3ff); color:#000; font-weight:700; border:0}
    .table tbody tr td{vertical-align:middle}
    .small-muted{color:var(--muted); font-size:0.9rem}

    /* responsive table - allow horizontal scroll */
    .table-responsive { overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .table-minwidth { min-width:900px; } /* ensures columns don't wrap too early on mobile */

    /* charts */
    canvas { width:100% !important; height:260px !important; display:block; }

    /* history modal */
    #aboutModal, #historyModal{display:none; position:fixed; inset:0; z-index:9999; background:rgba(2,6,23,0.6); padding:30px; box-sizing:border-box;}
    #historyModal .modal-card, #aboutModal .modal-card{max-width:820px; margin:auto; background:var(--card); padding:20px; border-radius:12px; box-shadow:0 10px 30px rgba(11,19,32,0.12);}
    .field-changed {font-weight:700; color:#ff9900}
    footer{max-width:1100px;margin:20px auto 40px;padding:10px;color:var(--muted); text-align:center}
    .hidden {display:none !important}
  </style>
</head>
<body>

  <!-- TOPBAR -->
  <div class="topbar d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-3">
      <div class="brand">E-Trax Dashboard</div>
      <div class="sub">Parallel Tracking Sense ‚Äî expenses, budgets & insights</div>
    </div>
    <div id="userArea" class="d-flex align-items-center gap-3">
      <div id="userNameDisplay" class="small-muted"></div>
      <button id="googleLogoutBtn" class="btn btn-outline-secondary btn-sm hidden">Logout</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="container-main">
    <!-- LOGIN -->
    <div id="loginContainer" class="card-elev" style="border-radius:12px;">
      <div style="text-align:center; width:100%;">
        <h3 style="margin-bottom:6px;">Welcome to E-Trax</h3>
        <p class="small-muted" style="margin-bottom:14px;">Sign in with Google to view and manage your expenses</p>
        <button id="googleLoginBtn" class="btn-google">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="g">
          Sign in with Google
        </button>
        <div id="loginInfo" class="small-muted mt-3"></div>
      </div>
    </div>

    <!-- APP (hidden until login) -->
    <div id="appArea" class="hidden">

      <div class="grid-2 left-col right-col">
        <div>
          <div class="card-elev">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
              <div>
                <h5 style="margin:0;">Add / Edit Expense</h5>
                <div class="small-muted">Quickly add or update an expense</div>
              </div>
              <div class="small-muted">Signed in as <span id="signedInName"></span></div>
            </div>

            <form id="expenseForm" class="mt-3">
              <input type="hidden" id="editId">
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="small-muted">Name</label>
                  <input id="name" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="small-muted">Amount (‚Çπ)</label>
                  <input id="amount" type="number" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="small-muted">Type</label>
                  <select id="type" class="form-select" required>
                    <option value="">Choose</option>
                    <option>Card</option>
                    <option>Cash</option>
                    <option>Gpay/Paytm</option>
                    <option>Other</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="small-muted">Date</label>
                  <input id="date" type="date" class="form-control" required>
                </div>
                <div class="col-12">
                  <label class="small-muted">Description</label>
                  <input id="description" class="form-control" required>
                </div>
                <div class="col-12 d-flex justify-content-between mt-2">
                  <button type="reset" class="btn btn-outline-danger">Clear</button>
                  <div>
                    <button type="submit" class="btn btn-primary">Confirm</button>
                  </div>
                </div>
              </div>
            </form>
          </div>

          <div id="tableCard" class="card-elev mt-3">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <h5 style="margin:0;">Expenses</h5>
                <div class="small-muted">All your recorded expenses</div>
              </div>
              <div>
                <button id="refreshBtn" class="btn btn-sm btn-outline-secondary">Refresh</button>
              </div>
            </div>

            <div id="tableContainer" class="mt-3 table-responsive"></div>
          </div>
        </div>

        <div class="right-col">
          <div class="card-elev">
            <div class="budget-head">
              <div>
                <h6 style="margin:0;">Budget Limit</h6>
                <div class="small-muted">Set monthly or total budget</div>
              </div>
              <div>
                <button id="resetBudgetBtn" class="btn btn-sm btn-outline-danger">Reset</button>
              </div>
            </div>

            <div class="mt-3">
              <div class="d-flex gap-2">
                <input id="budgetInput" type="number" class="form-control" placeholder="e.g. 5000">
                <button id="saveBudgetBtn" class="btn btn-primary">Save</button>
              </div>
              <div class="mt-2 small-muted" id="budgetStatusText">No budget set</div>
              <div class="mt-2">
                <div class="progress mt-2">
                  <div id="budgetProgressBar" class="progress-bar" role="progressbar" style="width:0%"></div>
                </div>
                <div id="budgetAlerts" class="mt-2"></div>
              </div>
            </div>
          </div>

          <div class="card-elev mt-3">
            <h6 style="margin:0;">Analytics</h6>
            <div class="small-muted mb-2">Spending by date & type</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
              <canvas id="lineChart" style="max-height:400px;"></canvas>
              <canvas id="pieChart" style="max-height:400px;"></canvas>
            </div>
            <div id="analyticsBadge" class="mt-2 small-muted"></div>
          </div>

          <div class="card-elev mt-3">
            <h6 style="margin:0;">Recent Activity</h6>
            <div id="activityItems" class="mt-2 small-muted"></div>
          </div>
        </div>
      </div>

    </div>

    <!-- ABOUT Modal -->
    <div id="aboutModal">
      <div class="modal-card">
        <h4>About Parallel Tracking Sense</h4>
        <p class="small-muted">Helps you track daily expenses and manage budget efficiently.</p>
        <div class="text-end"><button id="closeAbout" class="btn btn-secondary btn-sm">Close</button></div>
      </div>
    </div>

    <!-- HISTORY Modal -->
    <div id="historyModal">
      <div class="modal-card" id="historyContent">
        <h5 id="historyTitle">History</h5>
        <div id="historyList" class="mt-2 small-muted"></div>
        <div class="text-end mt-3"><button id="closeHistoryBtn" class="btn btn-secondary btn-sm">Close</button></div>
      </div>
    </div>

    <div id="msgBox" style="position:fixed; top:18px; right:18px; display:none; z-index:9999;"></div>
  </div>

  <footer>Developed by <strong style="color:var(--brand)">Prime Sandy</strong> ‚Äî &copy; 2025 E-Trax</footer>

  <script>
    // ********** CONFIG **********
    const BASE_URL = window.location.hostname.includes("localhost")
      ? "http://localhost:3000"
      : "https://sandy-backend2-0.onrender.com";

    // Firebase config (you said it's same & valid)
    const firebaseConfig = {
      apiKey: "AIzaSyDgeOmsWD36spVcXw9QVSbUs4nmx-iXGak",
      authDomain: "ptspro-31997.firebaseapp.com",
      projectId: "ptspro-31997",
      storageBucket: "ptspro-31997.appspot.com",
      messagingSenderId: "191965542623",
      appId: "1:191965542623:web:b461ceedfc3a773267516a",
      measurementId: "G-6LNC29KRQF"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // DOM
    const loginContainer = document.getElementById('loginContainer');
    const loginBtn = document.getElementById('googleLoginBtn');
    const loginInfo = document.getElementById('loginInfo');
    const appArea = document.getElementById('appArea');
    const userNameDisplay = document.getElementById('userNameDisplay');
    const signedInName = document.getElementById('signedInName');
    const logoutBtn = document.getElementById('googleLogoutBtn');
    const tableContainer = document.getElementById('tableContainer');
    const msgBox = document.getElementById('msgBox');
    const budgetInput = document.getElementById('budgetInput');
    const saveBudgetBtn = document.getElementById('saveBudgetBtn');
    const resetBudgetBtn = document.getElementById('resetBudgetBtn');
    const budgetProgressBar = document.getElementById('budgetProgressBar');
    const budgetStatusText = document.getElementById('budgetStatusText');
    const budgetAlerts = document.getElementById('budgetAlerts');
    const analyticsBadge = document.getElementById('analyticsBadge');
    const form = document.getElementById('expenseForm');
    const editId = document.getElementById('editId');
    const historyModal = document.getElementById('historyModal');
    const historyList = document.getElementById('historyList');
    const historyTitle = document.getElementById('historyTitle');
    const refreshBtn = document.getElementById('refreshBtn');

    // charts
    let lineChartInstance = null, pieChartInstance = null;

    // socket
    let socket = null;
    let socketIoLoaded = false;

    // globals
    let currentUserUid = null;
    let currentBudgetAmount = 0;

    // util
    function showMessage(txt, success=true, time=2200){
      msgBox.innerText = txt;
      msgBox.style.display = 'block';
      msgBox.style.background = success ? '#198754' : '#d63384';
      msgBox.style.color = '#fff';
      setTimeout(()=> msgBox.style.display = 'none', time);
    }

    function formatDateString(d){
      if(!d) return "‚Äî";
      // d may be Date object, ISO string, or number
      const dt = (typeof d === 'string' || typeof d === 'number') ? new Date(d) : d;
      if(!dt || isNaN(dt.getTime())) return String(d);
      const opts = { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' };
      return dt.toLocaleString('en-GB', opts);
    }

    // load socket.io client script from backend
    (function loadSocketIo(){
      const s = document.createElement('script');
      s.src = `${BASE_URL.replace(/\/$/,'')}/socket.io/socket.io.js`;
      s.onload = ()=>{ socketIoLoaded = true; if(currentUserUid) connectSocket(); };
      s.onerror = ()=>{ socketIoLoaded = false; console.warn('socket.io load failed'); };
      document.head.appendChild(s);
    })();

    function connectSocket(retries=0){
      try{
        if(typeof io === 'undefined'){
          if(retries < 5) setTimeout(()=> connectSocket(retries+1), 700);
          return;
        }
        if(socket && socket.connected) return;
        socket = io(BASE_URL);
        socket.on('connect', ()=>{ if(currentUserUid) socket.emit('join', currentUserUid); });
        socket.on('expenses-changed', ()=> loadData());
        socket.on('budget-changed', ()=> fetchBudget());
      }catch(e){ console.warn('socket connect err', e); }
    }

    // auth state
    auth.onAuthStateChanged(async user=>{
      if(user){
        currentUserUid = user.uid;
        loginContainer.classList.add('hidden');
        appArea.classList.remove('hidden');
        logoutBtn.classList.remove('hidden');
        userNameDisplay.innerText = user.displayName || user.email || 'User';
        signedInName.innerText = user.displayName || 'User';
        try{ if(socketIoLoaded) connectSocket(); else connectSocket(); }catch(e){}
        await loadData();
        await fetchBudget();
      } else {
        currentUserUid = null;
        loginContainer.classList.remove('hidden');
        appArea.classList.add('hidden');
        logoutBtn.classList.add('hidden');
        userNameDisplay.innerText = '';
        signedInName.innerText = '';
        tableContainer.innerHTML = '<div class="small-muted">Login to view your expenses</div>';
        if(socket){ socket.disconnect(); socket = null; }
        clearBudgetUI();
      }
    });

    // login
    loginBtn.addEventListener('click', async ()=>{
      loginInfo.innerText = 'Opening Google sign-in...';
      const provider = new firebase.auth.GoogleAuthProvider();
      try{
        const res = await auth.signInWithPopup(provider);
        loginInfo.innerText = '';
        showMessage('‚úÖ Logged in');
      }catch(err){
        console.error('Login error', err);
        loginInfo.innerText = 'Login failed: ' + (err.message || '');
        showMessage('‚ùå Login failed ‚Äî check console', false);
      }
    });

    logoutBtn.addEventListener('click', async ()=>{
      try{
        await auth.signOut();
        showMessage('‚úÖ Logged out');
      }catch(e){ console.error(e); showMessage('‚ùå Logout failed', false); }
    });

    // form submit
    form.addEventListener('submit', async e=>{
      e.preventDefault();
      if(!currentUserUid) return showMessage('Login first', false);
      const payload = {
        uid: currentUserUid,
        name: document.getElementById('name').value.trim(),
        amount: document.getElementById('amount').value.trim(),
        type: document.getElementById('type').value,
        description: document.getElementById('description').value.trim(),
        date: document.getElementById('date').value
      };
      try{
        const url = editId.value ? `${BASE_URL}/update/${editId.value}` : `${BASE_URL}/submit`;
        if(editId.value) payload.editorName = (auth.currentUser && auth.currentUser.displayName) ? auth.currentUser.displayName : null;
        const res = await fetch(url, { method: editId.value ? 'PUT' : 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const json = await res.json();
        if(!res.ok) throw new Error(json.message || 'Server error');
        showMessage(json.message || 'Saved');
        editId.value = '';
        form.reset();
        await loadData();
        await fetchBudget();
      }catch(err){ console.error(err); showMessage('‚ùå Failed to submit/edit expense', false); }
    });

    // budget
    saveBudgetBtn.addEventListener('click', async ()=>{
      if(!currentUserUid) return showMessage('Login first', false);
      const val = parseFloat(budgetInput.value);
      if(!val || val <= 0) return showMessage('Enter valid budget amount', false);
      try{
        const res = await fetch(`${BASE_URL}/setBudget`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid: currentUserUid, amount: val })});
        const r = await res.json();
        if(res.ok) showMessage(r.message || 'Budget saved'); else showMessage(r.message || 'Save failed', false);
        await fetchBudget();
      }catch(e){ console.error(e); showMessage('‚ùå Failed to save budget', false); }
    });

    resetBudgetBtn.addEventListener('click', async ()=>{
      if(!currentUserUid) return showMessage('Login first', false);
      if(!confirm('Reset/delete your budget?')) return;
      try{
        const res = await fetch(`${BASE_URL}/setBudget`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid: currentUserUid, amount:0, reset:true })});
        const r = await res.json();
        if(res.ok) showMessage(r.message || 'Budget reset'); else showMessage('Reset failed', false);
        clearBudgetUI();
      }catch(e){ console.error(e); showMessage('‚ùå Reset failed', false); }
    });

    function clearBudgetUI(){
      budgetInput.value = '';
      budgetProgressBar.style.width = '0%';
      budgetStatusText.innerText = 'No budget set';
      budgetAlerts.innerHTML = '';
      currentBudgetAmount = 0;
      analyticsBadge.innerText = '';
    }

    async function fetchBudget(){
      if(!currentUserUid) return clearBudgetUI();
      try{
        const res = await fetch(`${BASE_URL}/getBudget?uid=${currentUserUid}`);
        if(!res.ok) return clearBudgetUI();
        const r = await res.json();
        if(!r || typeof r.amount === 'undefined' || r.amount === 0){ currentBudgetAmount = 0; clearBudgetUI(); return; }
        currentBudgetAmount = parseFloat(r.amount) || 0;
        // compute current total
        const expensesRes = await fetch(`${BASE_URL}/users?uid=${currentUserUid}`);
        const arr = await expensesRes.json();
        let totalAmount = 0;
        if(Array.isArray(arr)) arr.forEach(x=> totalAmount += parseFloat(x.amount)||0);
        updateBudgetUI(currentBudgetAmount, totalAmount);
        budgetInput.value = currentBudgetAmount;
      }catch(e){ console.error(e); clearBudgetUI(); }
    }

    function updateBudgetUI(budgetAmount, totalSpent){
      if(!budgetAmount || budgetAmount <= 0){ clearBudgetUI(); return; }
      const pct = (totalSpent / budgetAmount) * 100;
      const pctClamped = Math.min(Math.round(pct), 999);
      const widthPct = Math.min(pctClamped, 100);
      budgetProgressBar.style.width = widthPct + '%';
      budgetStatusText.innerText = `Budget: ‚Çπ${budgetAmount.toFixed(2)}  ‚Äî  Spent: ‚Çπ${totalSpent.toFixed(2)}`;
      budgetAlerts.innerHTML = '';
      analyticsBadge.innerText = '';
      if(pct >= 100){ budgetProgressBar.className = 'progress-bar bg-danger'; const over = (totalSpent - budgetAmount); budgetAlerts.innerHTML = `<div style="font-weight:700;color:#d63384">üö® Budget exceeded! Over ‚Çπ${over.toFixed(2)}</div>`; analyticsBadge.innerText = `Over budget ‚Çπ${over.toFixed(2)}`; }
      else if(pct >= 80){ budgetProgressBar.className = 'progress-bar bg-warning'; budgetAlerts.innerHTML = `<div style="font-weight:700;color:#ff8c00">‚ö†Ô∏è ${Math.round(pct)}% of budget used</div>`; analyticsBadge.innerText = `Usage: ${Math.round(pct)}%`; }
      else { budgetProgressBar.className = 'progress-bar bg-success'; analyticsBadge.innerText = `Usage: ${Math.round(pct)}%`; }
    }

    // loadData - main
    async function loadData(){
      if(!currentUserUid) return;
      try{
        tableContainer.innerHTML = '<div class="small-muted">Loading...</div>';
        const res = await fetch(`${BASE_URL}/users?uid=${currentUserUid}`);
        if(!res.ok){ const txt = await res.text().catch(()=> ''); throw new Error(`Failed to fetch users: ${res.status} ${txt}`); }
        const users = await res.json();
        if(!Array.isArray(users) || users.length === 0){
          tableContainer.innerHTML = '<div class="small-muted">No expenses yet.</div>';
          renderCharts([]);
          document.getElementById('activityItems').innerHTML = '';
          return;
        }

        // build table
        let totalAmount = 0;
        let html = `<div class="table-responsive"><table class="table table-hover table-minwidth mt-2"><thead><tr>
          <th>#</th><th>Name</th><th>Amount</th><th>Type</th><th>Description</th><th>Date</th><th>Edits</th><th>Last Edited</th><th>Action</th>
        </tr></thead><tbody>`;
        users.forEach((u,i)=>{
          totalAmount += parseFloat(u.amount) || 0;
          const editCount = u.editCount || 0;
          const lastEdited = u.updatedAt || u.createdAt || null;
          const id = u._id;
          html += `<tr>
            <td>${i+1}</td>
            <td>${escapeHtml(u.name || '')}</td>
            <td>‚Çπ${(parseFloat(u.amount)||0).toFixed(2)}</td>
            <td>${escapeHtml(u.type || '')}</td>
            <td>${escapeHtml(u.description || '')}</td>
            <td>${escapeHtml(u.date || '')}</td>
            <td><strong>${editCount}</strong></td>
            <td>${formatDateString(lastEdited)}</td>
            <td>
              <button class="btn btn-sm btn-outline-warning" onclick="editExpense('${id}')">Edit</button>
              <button class="btn btn-sm btn-outline-info ms-1" onclick="viewHistory('${id}')">History</button>
            </td>
          </tr>`;
        });
        html += `<tr style="background:linear-gradient(90deg,var(--accent),#4aa3ff); color:#000; font-weight:700;"><td colspan="2" class="text-end">Total</td><td colspan="7">‚Çπ${totalAmount.toFixed(2)}</td></tr>`;
        html += `</tbody></table></div>`;
        tableContainer.innerHTML = html;

        renderCharts(users);
        renderActivityLog(users);
      }catch(err){
        console.error(err);
        tableContainer.innerHTML = `<div style="color:#d63384">Failed to load expenses. ${err.message || ''}</div>`;
      }
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // global edit + view history functions (exposed)
    window.editExpense = async function(id){
      try{
        const res = await fetch(`${BASE_URL}/user/${id}`);
        if(!res.ok) throw new Error('Failed to fetch expense');
        const u = await res.json();
        document.getElementById('name').value = u.name || '';
        document.getElementById('amount').value = u.amount || '';
        document.getElementById('type').value = u.type || '';
        document.getElementById('description').value = u.description || '';
        document.getElementById('date').value = u.date || '';
        editId.value = id;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        showMessage('‚úèÔ∏è Edit mode enabled');
      }catch(e){ console.error(e); showMessage('‚ùå Failed to load expense for edit', false); }
    };

    window.viewHistory = async function(id){
      try{
        const res = await fetch(`${BASE_URL}/user/${id}`);
        if(!res.ok) throw new Error('Failed to fetch history');
        const u = await res.json();
        historyTitle.innerText = `History for: ${u.name || 'Expense'}`;
        historyList.innerHTML = '';
        historyList.insertAdjacentHTML('beforeend', `<div><strong>Created:</strong> ${formatDateString(u.createdAt)}</div><div class="small-muted">Initial values.</div><hr>`);
        const hist = Array.isArray(u.editHistory) ? u.editHistory.slice().reverse() : [];
        if(hist.length === 0){
          historyList.insertAdjacentHTML('beforeend', `<div class="small-muted">No edits yet.</div>`);
        } else {
          hist.forEach(h=>{
            const changedFields = [];
            if(h.before && h.after){
              for(const k of Object.keys(h.before)) if(String(h.before[k]) !== String(h.after[k])) changedFields.push(k);
            }
            const changedText = changedFields.length ? `<div>Changed: <span class="field-changed">${changedFields.join(', ')}</span></div>` : `<div class="small-muted">No field differences</div>`;
            const editor = h.editorName || h.editorUid || 'Unknown';
            historyList.insertAdjacentHTML('beforeend', `<div style="margin-bottom:12px;"><div><strong>${editor}</strong> ‚Äî ${formatDateString(h.date)}</div>${changedText}
              <details style="margin-top:8px;"><summary>Show before / after</summary><pre style="background:#f6f8fb;padding:8px;border-radius:6px;">Before: ${JSON.stringify(h.before,null,2)}\n\nAfter: ${JSON.stringify(h.after,null,2)}</pre></details></div><hr>`);
          });
        }
        historyModal.style.display = 'block';
      }catch(e){ console.error(e); showMessage('‚ùå Failed to load history', false); }
    };

    // charts
    function renderCharts(users){
      const dates = {}, types = {};
      let totalAmount = 0;
      (users||[]).forEach(u=>{
        const date = u.date || 'Unknown';
        const amount = parseFloat(u.amount) || 0;
        totalAmount += amount;
        dates[date] = (dates[date]||0) + amount;
        const t = (u.type && u.type.length) ? u.type : 'Other';
        types[t] = (types[t]||0) + amount;
      });

      const overAmount = currentBudgetAmount && totalAmount > currentBudgetAmount ? (totalAmount - currentBudgetAmount) : 0;
      if(overAmount > 0) types[`Over Budget (‚Çπ${overAmount.toFixed(2)})`] = (types[`Over Budget (‚Çπ${overAmount.toFixed(2)})`]||0) + overAmount;

      // line
      const lineCtx = document.getElementById('lineChart').getContext('2d');
      if(lineChartInstance) lineChartInstance.destroy();
      lineChartInstance = new Chart(lineCtx, {
        type: 'line',
        data: { labels: Object.keys(dates), datasets:[{ label:'Total Expense', data: Object.values(dates), borderColor:'#0d6efd', backgroundColor:'rgba(13,110,253,0.12)', fill:true, tension:0.3 }] },
        options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
      });

      // pie
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      if(pieChartInstance) pieChartInstance.destroy();
      const labels = Object.keys(types), values = Object.values(types);
      const baseColors = ['#0d6efd','#00bcd4','#ff9800','#8bc34a','#9c27b0','#3f51b5','#e91e63'];
      const bg = labels.map(l => l.startsWith('Over Budget') ? '#ff3b30' : baseColors.shift() || '#607d8b');
      pieChartInstance = new Chart(pieCtx, { type:'pie', data:{ labels, datasets:[{ data: values, backgroundColor: bg }] }, options:{ responsive:true, maintainAspectRatio:false } });

      if(overAmount > 0) analyticsBadge.innerText = `üö® Over budget: ‚Çπ${overAmount.toFixed(2)}`;
      else if(currentBudgetAmount > 0) analyticsBadge.innerText = `‚úÖ Budget ‚Çπ${currentBudgetAmount.toFixed(2)} ‚Äî Spent ‚Çπ${totalAmount.toFixed(2)}`;
      else analyticsBadge.innerText = '';
    }

    // activity log
    function renderActivityLog(allUsers){
      const log = [];
      allUsers.forEach(u=>{
        if(u.createdAt) log.push({ type:'created', display:`${u.name} created`, date:u.createdAt });
        if(Array.isArray(u.editHistory)) u.editHistory.forEach(e=> log.push({ type:'edited', expenseName:u.name, editorName:e.editorName||e.editorUid||'Unknown', date:e.date, before:e.before, after:e.after }));
      });
      log.sort((a,b)=> new Date(b.date) - new Date(a.date));
      const limited = log.slice(0,20);
      const div = document.getElementById('activityItems'); div.innerHTML = '';
      if(limited.length === 0) { div.innerHTML = '<div class="small-muted">No recent activity</div>'; return; }
      limited.forEach(it=>{
        if(it.type === 'created') div.insertAdjacentHTML('beforeend', `<div>üìå <strong>${it.display}</strong> ‚Äî ${formatDateString(it.date)}</div>`);
        else {
          const changed = [];
          if(it.before && it.after) for(const k of Object.keys(it.before)) if(String(it.before[k]) !== String(it.after[k])) changed.push(k);
          div.insertAdjacentHTML('beforeend', `<div>‚úèÔ∏è <strong>${it.editorName}</strong> edited <strong>${it.expenseName || ''}</strong> ‚Äî ${changed.length ? `<span class="field-changed">${changed.join(', ')}</span>` : '<span class="small-muted">no fields</span>'} ‚Äî ${formatDateString(it.date)}</div>`);
        }
      });
    }

    // refresh button
    refreshBtn.addEventListener('click', ()=> loadData());

    // history modal close
    document.getElementById('closeHistoryBtn').addEventListener('click', ()=> historyModal.style.display='none');
    document.getElementById('closeAbout').addEventListener('click', ()=> document.getElementById('aboutModal').style.display='none');
    window.addEventListener('click', e=> { if(e.target === historyModal) historyModal.style.display='none'; if(e.target === document.getElementById('aboutModal')) document.getElementById('aboutModal').style.display='none'; });

    // initial ui
    tableContainer.innerHTML = '<div class="small-muted">Login to view your expenses</div>';
  </script>
</body>
</html>
