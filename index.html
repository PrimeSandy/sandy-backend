<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>E-TRAX | Smart Expense Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #00bcd4;
            --primary-dark: #0097a7;
            --secondary: #ffcc00;
            --background: #0b0b0b;
            --card-bg: #1a1a1a;
            --text: #ffffff;
            --text-light: #f1f5f9;
            --text-muted: #cbd5e1;
            --border: rgba(255,255,255,0.2);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow: 0 10px 30px rgba(0,0,0,0.6);
        }

        [data-theme="light"] {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #dc2626;
            --background: #ffffff;
            --card-bg: #f8fafc;
            --text: #000000;
            --text-light: #1e293b;
            --text-muted: #475569;
            --border: rgba(0,0,0,0.15);
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        [data-theme="professional"] {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #f59e0b;
            --background: #0f172a;
            --card-bg: #1e293b;
            --text: #ffffff;
            --text-light: #e2e8f0;
            --text-muted: #94a3b8;
            --border: rgba(255,255,255,0.2);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        * {
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            font-family: "Poppins", sans-serif;
            margin: 0;
            min-height: 100vh;
        }

        /* Login Styles */
        .login-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--background) 0%, var(--card-bg) 100%);
        }

        .login-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 40px 30px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .login-card h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .google-btn {
            background: white;
            color: #333;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 20px;
        }

        .google-btn:hover {
            background: #f5f5f5;
        }

        /* Header */
        header {
            display: none;
            background: var(--card-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        header.visible {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            margin-bottom: 20px;
        }

        .card-header {
            background: rgba(0,0,0,0.1);
            border-bottom: 1px solid var(--border);
            color: var(--primary);
            font-weight: 600;
            padding: 15px 20px;
        }

        .card-body {
            padding: 20px;
        }

        /* Forms */
        .form-control, .form-select {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .form-control:focus, .form-select:focus {
            background: var(--card-bg);
            color: var(--text);
            border-color: var(--primary);
        }

        /* Buttons */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            padding: 10px 20px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            border: none;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-danger {
            background: var(--danger);
            border: none;
        }

        .btn-warning {
            background: var(--warning);
            color: black;
            border: none;
        }

        /* Message Box */
        #msgBox {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            display: none;
            z-index: 9999;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Footer */
        footer {
            background: var(--card-bg);
            color: var(--text-muted);
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            border-top: 1px solid var(--border);
        }
    </style>
</head>
<body>

<!-- Login View -->
<div id="loginView" class="login-wrapper">
    <div class="login-card">
        <h1>E-TRAX</h1>
        <p>Track your expenses smartly. Sign in with Google to continue.</p>
        <button id="googleLoginBtn" class="google-btn">
            <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" width="20" height="20">
            Sign in with Google
        </button>
        <p class="small-note mt-3" style="color: var(--text-muted); font-size: 0.9rem;">
            We only use Google to authenticate you.
        </p>
    </div>
</div>

<!-- Header -->
<header id="mainHeader">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 style="color: var(--primary); margin: 0; font-size: 1.5rem;">E-TRAX</h1>
                <div id="typingHeader" style="color: var(--secondary); font-size: 0.9rem;"></div>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div id="userNameDisplay" style="color: var(--secondary); font-weight: 600;"></div>
                <button id="themeToggle" class="btn btn-sm" style="background: var(--card-bg); color: var(--text);">
                    <i class="fas fa-palette"></i>
                </button>
                <button id="googleLogoutBtn" class="btn btn-sm btn-danger">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<div class="container my-4" id="mainContent" style="display: none;">
    
    <!-- Budget Card -->
    <div class="card" id="budgetCard">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-wallet"></i> Budget Management</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <input type="number" id="budgetInput" class="form-control" placeholder="Enter budget amount">
                </div>
                <div class="col-md-3">
                    <button id="saveBudgetBtn" class="btn btn-primary w-100">Save Budget</button>
                </div>
                <div class="col-md-3">
                    <button id="resetBudgetBtn" class="btn btn-outline-danger w-100">Reset</button>
                </div>
            </div>
            <div class="mt-3">
                <div id="budgetStatusText" style="font-weight: 600;"></div>
                <div id="budgetBar" class="mt-2" style="height: 20px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div id="budgetProgressBar" style="height: 100%; background: var(--success); width: 0%; transition: width 0.5s;"></div>
                </div>
                <div id="budgetAlerts" class="mt-2"></div>
            </div>
        </div>
    </div>

    <!-- Expense Form -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Add New Expense</h5>
        </div>
        <div class="card-body">
            <form id="expenseForm">
                <input type="hidden" id="editId">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Name</label>
                        <input type="text" id="name" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Amount (₹)</label>
                        <input type="number" id="amount" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Type</label>
                        <select id="type" class="form-select" required>
                            <option value="">Select type</option>
                            <option value="Card">Card</option>
                            <option value="Cash">Cash</option>
                            <option value="Gpay/Paytm">Gpay/Paytm</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Date</label>
                        <input type="date" id="date" class="form-control" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Description</label>
                        <input type="text" id="description" class="form-control" required>
                    </div>
                    <div class="col-12 d-flex justify-content-between mt-3">
                        <button type="reset" class="btn btn-danger">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i> Confirm
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Expenses Table -->
    <div id="tableContainer" class="mt-4">
        <!-- Will be populated by JavaScript -->
    </div>

    <!-- Analytics -->
    <div id="analyticsContainer" class="mt-4" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Analytics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="lineChart" height="250"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="pieChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Message Box -->
<div id="msgBox"></div>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDgeOmsWD36spVcXw9QVSbUs4nmx-iXGak",
        authDomain: "ptspro-31997.firebaseapp.com",
        projectId: "ptspro-31997",
        storageBucket: "ptspro-31997.firebasestorage.app",
        messagingSenderId: "191965542623",
        appId: "1:191965542623:web:b461ceedfc3a773267516a",
        measurementId: "G-6LNC29KRQF"
    };

    // Initialize Firebase
    try {
        firebase.initializeApp(firebaseConfig);
        console.log("✅ Firebase initialized successfully");
    } catch (error) {
        console.error("❌ Firebase initialization error:", error);
        alert("Firebase initialization failed. Please check console for details.");
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    // State variables
    let currentUser = null;
    let currentTheme = 'dark';
    let currentBudget = 0;

    // DOM Elements
    const loginView = document.getElementById('loginView');
    const mainHeader = document.getElementById('mainHeader');
    const mainContent = document.getElementById('mainContent');
    const userNameDisplay = document.getElementById('userNameDisplay');
    const googleLoginBtn = document.getElementById('googleLoginBtn');
    const googleLogoutBtn = document.getElementById('googleLogoutBtn');
    const themeToggle = document.getElementById('themeToggle');
    const tableContainer = document.getElementById('tableContainer');
    const analyticsContainer = document.getElementById('analyticsContainer');
    const msgBox = document.getElementById('msgBox');

    // Budget elements
    const budgetCard = document.getElementById('budgetCard');
    const budgetInput = document.getElementById('budgetInput');
    const saveBudgetBtn = document.getElementById('saveBudgetBtn');
    const resetBudgetBtn = document.getElementById('resetBudgetBtn');
    const budgetStatusText = document.getElementById('budgetStatusText');
    const budgetProgressBar = document.getElementById('budgetProgressBar');
    const budgetAlerts = document.getElementById('budgetAlerts');

    // Expense form elements
    const expenseForm = document.getElementById('expenseForm');
    const editId = document.getElementById('editId');
    const nameInput = document.getElementById('name');
    const amountInput = document.getElementById('amount');
    const typeInput = document.getElementById('type');
    const dateInput = document.getElementById('date');
    const descriptionInput = document.getElementById('description');

    // Set default date to today
    dateInput.valueAsDate = new Date();

    // Initialize theme
    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        currentTheme = savedTheme;
    }

    // Toggle theme
    themeToggle.addEventListener('click', () => {
        const themes = ['dark', 'light', 'professional'];
        const currentIndex = themes.indexOf(currentTheme);
        const nextIndex = (currentIndex + 1) % themes.length;
        currentTheme = themes[nextIndex];
        document.documentElement.setAttribute('data-theme', currentTheme);
        localStorage.setItem('theme', currentTheme);
    });

    // Show message
    function showMessage(message, type = 'success', duration = 3000) {
        msgBox.textContent = message;
        msgBox.style.display = 'block';
        msgBox.style.background = type === 'error' ? 'var(--danger)' : 'var(--success)';
        
        setTimeout(() => {
            msgBox.style.display = 'none';
        }, duration);
    }

    // Toggle login state
    function toggleLoginState(isLoggedIn) {
        if (isLoggedIn) {
            loginView.style.display = 'none';
            mainHeader.style.display = 'block';
            mainContent.style.display = 'block';
            mainHeader.classList.add('visible');
        } else {
            loginView.style.display = 'flex';
            mainHeader.style.display = 'none';
            mainContent.style.display = 'none';
            mainHeader.classList.remove('visible');
            tableContainer.innerHTML = '';
            analyticsContainer.style.display = 'none';
        }
    }

    // Typing animation
    const typingHeader = document.getElementById('typingHeader');
    const headerText = "Track Your Expenses Smartly!";
    let charIndex = 0;

    function typeWriter() {
        if (charIndex < headerText.length) {
            typingHeader.textContent += headerText.charAt(charIndex);
            charIndex++;
            setTimeout(typeWriter, 100);
        } else {
            setTimeout(() => {
                typingHeader.textContent = '';
                charIndex = 0;
                typeWriter();
            }, 2000);
        }
    }

    // Initialize typing animation
    typeWriter();

    // Auth state listener
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            console.log("✅ User logged in:", user.email);
            currentUser = user;
            userNameDisplay.textContent = `Hi, ${user.displayName || user.email}`;
            toggleLoginState(true);
            
            // Load data
            await loadExpenses();
            await loadBudget();
        } else {
            console.log("✅ User logged out");
            currentUser = null;
            userNameDisplay.textContent = '';
            toggleLoginState(false);
        }
    });

    // Google Login
    googleLoginBtn.addEventListener('click', async () => {
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            await auth.signInWithPopup(provider);
            showMessage('Successfully logged in!');
        } catch (error) {
            console.error('Login error:', error);
            showMessage('Login failed: ' + error.message, 'error');
        }
    });

    // Google Logout
    googleLogoutBtn.addEventListener('click', async () => {
        try {
            await auth.signOut();
            showMessage('Successfully logged out!');
        } catch (error) {
            console.error('Logout error:', error);
            showMessage('Logout failed: ' + error.message, 'error');
        }
    });

    // Load expenses
    async function loadExpenses() {
        if (!currentUser) return;
        
        try {
            console.log("Loading expenses for user:", currentUser.uid);
            
            const querySnapshot = await db.collection('expenses')
                .where('uid', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get();
            
            console.log("Found", querySnapshot.size, "expenses");
            
            if (querySnapshot.empty) {
                tableContainer.innerHTML = `
                    <div class="card">
                        <div class="card-body text-center">
                            <p class="text-muted mb-0">No expenses yet. Add your first expense above!</p>
                        </div>
                    </div>
                `;
                analyticsContainer.style.display = 'none';
                return;
            }
            
            const expenses = [];
            let totalAmount = 0;
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                expenses.push({
                    id: doc.id,
                    ...data
                });
                totalAmount += parseFloat(data.amount) || 0;
            });
            
            // Render table
            renderExpensesTable(expenses, totalAmount);
            
            // Show analytics
            analyticsContainer.style.display = 'block';
            renderCharts(expenses);
            
        } catch (error) {
            console.error('Error loading expenses:', error);
            tableContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Error loading expenses: ${error.message}
                    <br><small>Make sure you have set up Firebase Firestore properly.</small>
                </div>
            `;
        }
    }

    // Render expenses table
    function renderExpensesTable(expenses, totalAmount) {
        let html = `
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Expenses</h5>
                    <span class="badge bg-primary">Total: ₹${totalAmount.toFixed(2)}</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Name</th>
                                    <th>Amount</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        expenses.forEach((expense, index) => {
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${expense.name}</td>
                    <td>₹${parseFloat(expense.amount).toFixed(2)}</td>
                    <td><span class="badge bg-info">${expense.type}</span></td>
                    <td>${expense.description}</td>
                    <td>${expense.date}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="editExpense('${expense.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteExpense('${expense.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        tableContainer.innerHTML = html;
    }

    // Add/Edit expense
    expenseForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!currentUser) {
            showMessage('Please login first', 'error');
            return;
        }
        
        const expenseData = {
            name: nameInput.value.trim(),
            amount: parseFloat(amountInput.value) || 0,
            type: typeInput.value,
            description: descriptionInput.value.trim(),
            date: dateInput.value,
            uid: currentUser.uid,
            updatedAt: new Date()
        };
        
        try {
            if (editId.value) {
                // Update existing expense
                const updateData = {
                    ...expenseData,
                    editCount: firebase.firestore.FieldValue.increment(1)
                };
                
                await db.collection('expenses').doc(editId.value).update(updateData);
                showMessage('Expense updated successfully!');
                editId.value = '';
            } else {
                // Create new expense
                const newExpense = {
                    ...expenseData,
                    createdAt: new Date(),
                    editCount: 0,
                    editHistory: []
                };
                
                await db.collection('expenses').add(newExpense);
                showMessage('Expense added successfully!');
            }
            
            // Reset form
            expenseForm.reset();
            dateInput.valueAsDate = new Date();
            
            // Reload data
            await loadExpenses();
            await loadBudget();
            
        } catch (error) {
            console.error('Error saving expense:', error);
            showMessage('Error saving expense: ' + error.message, 'error');
        }
    });

    // Edit expense
    window.editExpense = async function(expenseId) {
        try {
            const doc = await db.collection('expenses').doc(expenseId).get();
            if (doc.exists) {
                const data = doc.data();
                nameInput.value = data.name;
                amountInput.value = data.amount;
                typeInput.value = data.type;
                descriptionInput.value = data.description;
                dateInput.value = data.date;
                editId.value = expenseId;
                
                showMessage('Editing expense. Make changes and click Confirm.');
            }
        } catch (error) {
            console.error('Error loading expense:', error);
            showMessage('Error loading expense: ' + error.message, 'error');
        }
    };

    // Delete expense
    window.deleteExpense = async function(expenseId) {
        if (!confirm('Are you sure you want to delete this expense?')) {
            return;
        }
        
        try {
            await db.collection('expenses').doc(expenseId).delete();
            showMessage('Expense deleted successfully!');
            await loadExpenses();
            await loadBudget();
        } catch (error) {
            console.error('Error deleting expense:', error);
            showMessage('Error deleting expense: ' + error.message, 'error');
        }
    };

    // Budget functions
    async function loadBudget() {
        if (!currentUser) return;
        
        try {
            const doc = await db.collection('budgets').doc(currentUser.uid).get();
            
            if (doc.exists) {
                const data = doc.data();
                currentBudget = parseFloat(data.amount) || 0;
                budgetInput.value = currentBudget;
                updateBudgetDisplay();
            } else {
                currentBudget = 0;
                budgetInput.value = '';
                budgetStatusText.textContent = 'No budget set';
                budgetProgressBar.style.width = '0%';
                budgetAlerts.innerHTML = '';
            }
        } catch (error) {
            console.error('Error loading budget:', error);
            currentBudget = 0;
        }
    }

    async function updateBudgetDisplay() {
        if (!currentUser || currentBudget <= 0) return;
        
        try {
            const querySnapshot = await db.collection('expenses')
                .where('uid', '==', currentUser.uid)
                .get();
            
            let totalSpent = 0;
            querySnapshot.forEach(doc => {
                const data = doc.data();
                totalSpent += parseFloat(data.amount) || 0;
            });
            
            const percentage = Math.min((totalSpent / currentBudget) * 100, 100);
            
            budgetStatusText.textContent = `Budget: ₹${currentBudget.toFixed(2)} | Spent: ₹${totalSpent.toFixed(2)}`;
            budgetProgressBar.style.width = `${percentage}%`;
            
            // Update progress bar color
            if (percentage >= 100) {
                budgetProgressBar.style.background = 'var(--danger)';
                budgetAlerts.innerHTML = `<div class="alert alert-danger mt-2 mb-0 py-2">Budget exceeded by ₹${(totalSpent - currentBudget).toFixed(2)}</div>`;
            } else if (percentage >= 80) {
                budgetProgressBar.style.background = 'var(--warning)';
                budgetAlerts.innerHTML = `<div class="alert alert-warning mt-2 mb-0 py-2">Approaching budget limit (${percentage.toFixed(1)}%)</div>`;
            } else {
                budgetProgressBar.style.background = 'var(--success)';
                budgetAlerts.innerHTML = '';
            }
            
        } catch (error) {
            console.error('Error calculating budget:', error);
        }
    }

    saveBudgetBtn.addEventListener('click', async () => {
        if (!currentUser) {
            showMessage('Please login first', 'error');
            return;
        }
        
        const amount = parseFloat(budgetInput.value);
        if (!amount || amount <= 0) {
            showMessage('Please enter a valid budget amount', 'error');
            return;
        }
        
        try {
            await db.collection('budgets').doc(currentUser.uid).set({
                amount: amount,
                updatedAt: new Date()
            }, { merge: true });
            
            currentBudget = amount;
            showMessage('Budget saved successfully!');
            await updateBudgetDisplay();
            
        } catch (error) {
            console.error('Error saving budget:', error);
            showMessage('Error saving budget: ' + error.message, 'error');
        }
    });

    resetBudgetBtn.addEventListener('click', async () => {
        if (!currentUser) return;
        
        if (!confirm('Reset your budget to zero?')) {
            return;
        }
        
        try {
            await db.collection('budgets').doc(currentUser.uid).delete();
            budgetInput.value = '';
            currentBudget = 0;
            budgetStatusText.textContent = 'No budget set';
            budgetProgressBar.style.width = '0%';
            budgetAlerts.innerHTML = '';
            showMessage('Budget reset successfully!');
        } catch (error) {
            console.error('Error resetting budget:', error);
            showMessage('Error resetting budget: ' + error.message, 'error');
        }
    });

    // Charts
    function renderCharts(expenses) {
        // Line chart - Daily expenses
        const dates = {};
        expenses.forEach(expense => {
            dates[expense.date] = (dates[expense.date] || 0) + parseFloat(expense.amount);
        });
        
        const lineCtx = document.getElementById('lineChart').getContext('2d');
        if (window.lineChart) {
            window.lineChart.destroy();
        }
        
        window.lineChart = new Chart(lineCtx, {
            type: 'line',
            data: {
                labels: Object.keys(dates),
                datasets: [{
                    label: 'Daily Expenses',
                    data: Object.values(dates),
                    borderColor: 'var(--primary)',
                    backgroundColor: 'rgba(0, 188, 212, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        labels: {
                            color: 'var(--text)'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: 'var(--text)'
                        },
                        grid: {
                            color: 'var(--border)'
                        }
                    },
                    y: {
                        ticks: {
                            color: 'var(--text)'
                        },
                        grid: {
                            color: 'var(--border)'
                        }
                    }
                }
            }
        });

        // Pie chart - Expense types
        const types = {};
        expenses.forEach(expense => {
            types[expense.type] = (types[expense.type] || 0) + parseFloat(expense.amount);
        });
        
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        if (window.pieChart) {
            window.pieChart.destroy();
        }
        
        window.pieChart = new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(types),
                datasets: [{
                    data: Object.values(types),
                    backgroundColor: [
                        '#00bcd4', // Cyan
                        '#ff9800', // Orange
                        '#8bc34a', // Green
                        '#e91e63', // Pink
                        '#9c27b0', // Purple
                        '#3f51b5'  // Blue
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: 'var(--text)'
                        }
                    }
                }
            }
        });
    }

    // Initialize
    initTheme();

    // Check if user is already logged in (persisted session)
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            console.log("User already logged in:", user.email);
            currentUser = user;
            userNameDisplay.textContent = `Hi, ${user.displayName || user.email}`;
            toggleLoginState(true);
            
            try {
                await loadExpenses();
                await loadBudget();
            } catch (error) {
                console.error("Error loading initial data:", error);
            }
        }
    });

</script>

<footer>
    <div class="container">
        <p class="mb-0">&copy; 2025 E-TRAX. Developed by Alpha Developers.</p>
    </div>
</footer>

</body>
</html>
