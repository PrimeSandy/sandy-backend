<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Firebase Test</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { margin: 5px; padding: 10px; }
        #debug { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Firebase Firestore Test</h1>
    
    <div>
        <button onclick="login()">Login with Google</button>
        <button onclick="logout()">Logout</button>
        <button onclick="testConnection()">Test Firestore Connection</button>
        <button onclick="addTestExpense()">Add Test Expense</button>
        <button onclick="loadExpenses()">Load Expenses</button>
    </div>
    
    <div id="debug">
        <h3>Debug Information:</h3>
        <div id="status">Ready...</div>
    </div>
    
    <div id="results"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDgeOmsWD36spVcXw9QVSbUs4nmx-iXGak",
            authDomain: "ptspro-31997.firebaseapp.com",
            projectId: "ptspro-31997",
            storageBucket: "ptspro-31997.firebasestorage.app",
            messagingSenderId: "191965542623",
            appId: "1:191965542623:web:b461ceedfc3a773267516a",
            measurementId: "G-6LNC29KRQF"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            logMessage("✅ Firebase initialized", "success");
        } catch (error) {
            logMessage("❌ Firebase init error: " + error.message, "error");
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;

        // Auth state listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                logMessage(`✅ User logged in: ${user.email} (UID: ${user.uid})`, "success");
            } else {
                currentUser = null;
                logMessage("⚠️ User logged out", "warning");
            }
        });

        function logMessage(message, type = "info") {
            const status = document.getElementById("status");
            const div = document.createElement("div");
            div.textContent = new Date().toLocaleTimeString() + " - " + message;
            div.className = type;
            status.prepend(div);
            console.log(type.toUpperCase() + ": " + message);
        }

        async function login() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                logMessage("✅ Login successful", "success");
            } catch (error) {
                logMessage("❌ Login error: " + error.message, "error");
            }
        }

        function logout() {
            auth.signOut();
            logMessage("✅ Logged out", "success");
        }

        async function testConnection() {
            try {
                logMessage("Testing Firestore connection...", "info");
                
                // Try to read a non-existent document to test connection
                const testDoc = await db.collection("test").doc("test").get();
                
                if (testDoc.exists) {
                    logMessage("✅ Firestore connection successful - Document exists", "success");
                } else {
                    logMessage("✅ Firestore connection successful - Document doesn't exist (this is normal)", "success");
                }
            } catch (error) {
                logMessage("❌ Firestore connection failed: " + error.message, "error");
                logMessage("Error code: " + error.code, "error");
            }
        }

        async function addTestExpense() {
            if (!currentUser) {
                logMessage("❌ Please login first", "error");
                return;
            }

            try {
                const expenseData = {
                    uid: currentUser.uid,
                    name: "Test Expense " + new Date().toLocaleTimeString(),
                    amount: Math.floor(Math.random() * 1000) + 100,
                    type: "Test",
                    description: "This is a test expense",
                    date: new Date().toISOString().split('T')[0],
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    editCount: 0,
                    editHistory: []
                };

                const docRef = await db.collection("expenses").add(expenseData);
                logMessage(`✅ Test expense added with ID: ${docRef.id}`, "success");
            } catch (error) {
                logMessage("❌ Error adding test expense: " + error.message, "error");
                logMessage("Error code: " + error.code, "error");
            }
        }

        async function loadExpenses() {
            if (!currentUser) {
                logMessage("❌ Please login first", "error");
                return;
            }

            try {
                logMessage(`Loading expenses for user: ${currentUser.uid}`, "info");
                
                const querySnapshot = await db.collection("expenses")
                    .where("uid", "==", currentUser.uid)
                    .limit(10)
                    .get();
                
                logMessage(`✅ Found ${querySnapshot.size} expenses`, "success");
                
                const resultsDiv = document.getElementById("results");
                resultsDiv.innerHTML = `<h3>Expenses (${querySnapshot.size}):</h3>`;
                
                if (querySnapshot.empty) {
                    resultsDiv.innerHTML += "<p>No expenses found.</p>";
                    return;
                }
                
                const ul = document.createElement("ul");
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const li = document.createElement("li");
                    li.textContent = `${data.name} - ₹${data.amount} - ${data.date}`;
                    ul.appendChild(li);
                });
                
                resultsDiv.appendChild(ul);
                
            } catch (error) {
                logMessage("❌ Error loading expenses: " + error.message, "error");
                logMessage("Error code: " + error.code, "error");
                logMessage("Error details: " + JSON.stringify(error), "error");
            }
        }

        // Initial test
        logMessage("App initialized. Click 'Test Firestore Connection' first.", "info");
    </script>
</body>
</html>
